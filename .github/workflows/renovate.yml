name: Renovate

on:
  workflow_dispatch: {}
  schedule:
    # Run during your Renovate schedule window (Australia/Melbourne after 8pm).
    # These times cover both AEST (UTC+10) and AEDT (UTC+11).
    - cron: "30 9 * * *"
    - cron: "30 10 * * *"

concurrency:
  group: renovate
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  statuses: read
  checks: read

jobs:
  renovate:
    runs-on: ubuntu-latest
    env:
      LOG_LEVEL: debug
      RENOVATE_AUTODISCOVER: "true"
      RENOVATE_AUTODISCOVER_FILTER: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Token source
        env:
          HAS_RENOVATE_TOKEN: ${{ secrets.RENOVATE_TOKEN != '' }}
        run: echo "HAS_RENOVATE_TOKEN=$HAS_RENOVATE_TOKEN (workflow uses GITHUB_TOKEN by default)"

      - name: Configure Docker Hub auth (optional)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          if [ -z "$DOCKERHUB_USERNAME" ] || [ -z "$DOCKERHUB_TOKEN" ]; then
            echo "Docker Hub secrets not set; skipping auth"
            exit 0
          fi

          echo "Configuring Renovate Docker Hub auth via RENOVATE_HOST_RULES"
          cat >> "$GITHUB_ENV" <<EOF
          RENOVATE_HOST_RULES=[{"hostType":"docker","matchHost":"index.docker.io","username":"$DOCKERHUB_USERNAME","password":"$DOCKERHUB_TOKEN"},{"hostType":"docker","matchHost":"registry-1.docker.io","username":"$DOCKERHUB_USERNAME","password":"$DOCKERHUB_TOKEN"}]
          EOF

      - name: Run Renovate
        uses: renovatebot/github-action@8b7941943a108b2cc2150730963164aa8baeab8c # v44.2.2
        with:
          # Use GitHub Actions' token by default.
          # If you switch this to a PAT, it MUST have access to read Issues via GraphQL, or Renovate can fail during initRepo().
          token: ${{ secrets.GITHUB_TOKEN }}
          configurationFile: renovate.json
