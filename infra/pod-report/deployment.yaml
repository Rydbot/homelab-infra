apiVersion: apps/v1
kind: Deployment
metadata:
  name: pod-report
  namespace: homepage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pod-report
  template:
    metadata:
      labels:
        app: pod-report
    spec:
      serviceAccountName: pod-report
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: generator
          image: bitnami/kubectl:latest@sha256:4c5f63828f5170142d714cdf1f96bad9e223f7ad79bd67d6d6b21e59a188c514
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-lc"]
          args:
            - |
              set -eu
              out="/work/index.html"
              tmp="/work/index.html.tmp"
              while true; do
                now="$(date -u '+%Y-%m-%d %H:%M:%SZ')"
                {
                  cat <<'HTML'
              <!doctype html>
              <html lang="en">
              <head>
                <meta charset="utf-8">
                <meta name="viewport" content="width=device-width, initial-scale=1">
                <title>Pods by Node</title>
                <style>
                  body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; margin: 16px; }
                  h1 { font-size: 18px; margin: 0 0 10px; }
                  h2 { font-size: 14px; margin: 18px 0 6px; }
                  .muted { color: #666; font-size: 12px; }
                  pre { background: #0b1020; color: #e6edf3; padding: 12px; border-radius: 10px; overflow: auto; }
                  code { white-space: pre; }
                  a { color: #3b82f6; text-decoration: none; }
                </style>
              </head>
              <body>
              HTML
                  printf '<h1>Pods by Node</h1><div class="muted">Generated %s</div>\n' "$now"
                  echo '<div class="muted">Tip: search in-page (Ctrl/Cmd+F).</div>'
                  echo '<pre><code>'

                  for node in $(kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | sort); do
                    echo ""
                    echo "### ${node}"
                    kubectl get pods -A \
                      --field-selector "spec.nodeName=${node},status.phase=Running" \
                      -o custom-columns='NAMESPACE:.metadata.namespace,POD:.metadata.name,READY:.status.containerStatuses[*].ready' \
                      --no-headers 2>/dev/null | sort || true
                  done

                  echo '</code></pre>'
                  cat <<'HTML'
              </body>
              </html>
              HTML
                } > "$tmp"
                mv "$tmp" "$out"
                sleep 30
              done
          volumeMounts:
            - name: web
              mountPath: /work
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
            seccompProfile:
              type: RuntimeDefault

        - name: web
          image: nginxinc/nginx-unprivileged:1.29-alpine@sha256:07ac04b4a727a38e7360f3bd8bbe49a7433a8e2a3259dd403d2c982e5f4c7a1c
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
              name: http
          volumeMounts:
            - name: web
              mountPath: /usr/share/nginx/html
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: false
            seccompProfile:
              type: RuntimeDefault

      volumes:
        - name: web
          emptyDir: {}
