apiVersion: v1
kind: ConfigMap
metadata:
  name: wotlk-accountmgr
  namespace: wotlk
data:
  index.php: |
    <?php
    declare(strict_types=1);

    function envOrDefault(string $key, string $default = ''): string {
      $val = getenv($key);
      return $val === false ? $default : $val;
    }

    function requestHeader(string $name): string {
      $key = 'HTTP_' . strtoupper(str_replace('-', '_', $name));
      return (string)($_SERVER[$key] ?? '');
    }

    function isHttpsRequest(): bool {
      // Behind Cloudflare Tunnel we’ll usually see HTTP at origin, with forwarded proto headers.
      $xfp = strtolower(requestHeader('X-Forwarded-Proto'));
      if ($xfp === 'https') return true;

      $cfv = requestHeader('CF-Visitor'); // e.g. {"scheme":"https"}
      if ($cfv !== '' && stripos($cfv, '"scheme":"https"') !== false) return true;

      $https = strtolower((string)($_SERVER['HTTPS'] ?? ''));
      return $https === 'on' || $https === '1';
    }

    function requireCloudflareAccessIfEnabled(): void {
      // Cloudflare Tunnel alone does NOT authenticate; Cloudflare Access does.
      // If enabled, require the Access JWT header to be present.
      if (envOrDefault('PORTAL_REQUIRE_CF_ACCESS', 'false') !== 'true') {
        return;
      }
      if (requestHeader('Cf-Access-Jwt-Assertion') === '') {
        http_response_code(403);
        echo "Forbidden (Cloudflare Access required).";
        exit;
      }
    }

    function isSignupEnabled(): bool {
      return envOrDefault('ALLOW_SIGNUP', 'false') === 'true';
    }

    function findPatchPath(): string {
      $candidates = [
        '/client/Data/patch-S.mpq',
        '/client/data/patch-S.mpq',
      ];
      foreach ($candidates as $path) {
        if (is_file($path)) {
          return $path;
        }
      }
      return '';
    }

    function handlePatchDownload(): void {
      $download = (string)($_GET['download'] ?? '');
      if ($download !== 'patch-s') {
        return;
      }

      requireCloudflareAccessIfEnabled();

      $path = findPatchPath();
      if ($path === '') {
        http_response_code(404);
        echo "Patch not available.";
        exit;
      }

      $size = filesize($path);
      header('Content-Type: application/octet-stream');
      header('Content-Disposition: attachment; filename=\"patch-S.mpq\"');
      if ($size !== false) {
        header('Content-Length: ' . (string)$size);
      }
      readfile($path);
      exit;
    }

    function requireInviteCode(string $provided): void {
      $invite = envOrDefault('INVITE_CODE');
      if ($invite === '') {
        throw new RuntimeException("Server misconfigured: INVITE_CODE not set.");
      }
      if (!hash_equals($invite, trim($provided))) {
        throw new RuntimeException("Invalid invite code.");
      }
    }

    function requirePhpExt(string $ext): void {
      if (!extension_loaded($ext)) {
        throw new RuntimeException("Server misconfigured: missing PHP extension '{$ext}'.");
      }
    }

    function wowUpper(string $s): string {
      // AzerothCore SRP expects username/password already uppercased (latin only).
      // Keep this strict to avoid subtle mismatches with non-ASCII characters.
      if (preg_match('/[^\\x20-\\x7E]/', $s)) {
        throw new RuntimeException("Only ASCII characters are supported for login on this portal.");
      }
      return strtoupper($s);
    }

    function normalizeUsername(string $username): string {
      $username = trim($username);
      if (!preg_match('/^[A-Za-z0-9_]{3,32}$/', $username)) {
        throw new RuntimeException("Username must be 3-32 chars and only A-Z, 0-9, underscore.");
      }
      return wowUpper($username);
    }

    function validatePassword(string $password): string {
      if ($password === '') {
        throw new RuntimeException("Password is required.");
      }
      if (strlen($password) > 16) {
        // WoW client limit
        throw new RuntimeException("Password must be 16 characters or less.");
      }
      return $password;
    }

    function validateEmail(string $email): string {
      $email = trim($email);
      if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        throw new RuntimeException("Email is invalid.");
      }
      if (strlen($email) > 255) {
        throw new RuntimeException("Email is too long.");
      }
      return $email;
    }

    function db(): PDO {
      requirePhpExt('pdo');
      requirePhpExt('pdo_mysql');

      $host = envOrDefault('DB_HOST');
      $port = envOrDefault('DB_PORT', '3306');
      $user = envOrDefault('DB_USER');
      $pass = envOrDefault('DB_PASSWORD');

      if ($host === '' || $user === '') {
        throw new RuntimeException("Server misconfigured: DB_HOST/DB_USER not set.");
      }

      $dsn = "mysql:host={$host};port={$port};charset=utf8mb4";
      return new PDO($dsn, $user, $pass, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
      ]);
    }

    function dbName(string $envKey, string $fallback): string {
      $v = envOrDefault($envKey, $fallback);
      if (!preg_match('/^[A-Za-z0-9_]+$/', $v)) {
        throw new RuntimeException("Server misconfigured: invalid {$envKey}.");
      }
      return $v;
    }

    function gmpFromLE(string $bytes): GMP {
      requirePhpExt('gmp');
      // word_size=1 + LSW_FIRST == little-endian bytes
      /** @var GMP $n */
      $n = gmp_import($bytes, 1, GMP_LSW_FIRST);
      return $n;
    }

    function gmpToLE(GMP $n, int $padLen): string {
      $b = gmp_export($n, 1, GMP_LSW_FIRST);
      if ($b === false) {
        $b = '';
      }
      if (strlen($b) > $padLen) {
        $b = substr($b, 0, $padLen);
      }
      return str_pad($b, $padLen, "\0", STR_PAD_RIGHT);
    }

    function srp6Verifier(string $usernameUpper, string $passwordUpper, string $salt32): string {
      // Matches AzerothCore SRP6::CalculateVerifier (little-endian BigNumber bytes in DB).
      // N (hex) is big-endian; AzerothCore stores it reversed in SRP6.cpp.
      $Nhex = '894B645E89E1535BBDAD5B8B290650530801B18EBFBF5E8FAB3C82872A3E9BB7';
      $N = gmpFromLE(strrev(hex2bin($Nhex)));
      $g = gmp_init(7, 10);

      $inner = sha1($usernameUpper . ':' . $passwordUpper, true);
      $x = sha1($salt32 . $inner, true); // 20 bytes
      $xInt = gmpFromLE($x);

      /** @var GMP $v */
      $v = gmp_powm($g, $xInt, $N);
      return gmpToLE($v, 32);
    }

    function tryLogin(string $username, string $password): array {
      $usernameUpper = normalizeUsername($username);
      $passwordUpper = wowUpper(validatePassword($password));

      $pdo = db();
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare("SELECT id, username, salt, verifier FROM {$authDb}.account WHERE username = :u LIMIT 1");
      $stmt->execute([':u' => $usernameUpper]);
      $row = $stmt->fetch();
      if (!$row) {
        throw new RuntimeException("Invalid username or password.");
      }

      $salt = (string)$row['salt'];
      $verifier = (string)$row['verifier'];
      if (strlen($salt) !== 32 || strlen($verifier) !== 32) {
        throw new RuntimeException("Server misconfigured: SRP fields have unexpected lengths.");
      }

      $calc = srp6Verifier($usernameUpper, $passwordUpper, $salt);
      if (!hash_equals($verifier, $calc)) {
        throw new RuntimeException("Invalid username or password.");
      }

      return [
        'account_id' => (int)$row['id'],
        'username' => (string)$row['username'],
      ];
    }

    function soapExecute(string $command): string {
      $soapUrl = envOrDefault('SOAP_URL', 'http://127.0.0.1:7878/');
      $soapUser = envOrDefault('SOAP_USERNAME');
      $soapPass = envOrDefault('SOAP_PASSWORD');

      if ($soapUser === '' || $soapPass === '') {
        throw new RuntimeException("Server misconfigured: SOAP_USERNAME/SOAP_PASSWORD not set.");
      }

      $envelope =
        '<?xml version="1.0" encoding="utf-8"?>' .
        '<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">' .
        '<SOAP-ENV:Body>' .
        '<executeCommand xmlns="urn:AC">' .
        '<command>' . htmlspecialchars($command, ENT_XML1 | ENT_QUOTES, 'UTF-8') . '</command>' .
        '</executeCommand>' .
        '</SOAP-ENV:Body>' .
        '</SOAP-ENV:Envelope>';

      $headers = [
        'Content-Type: text/xml; charset=utf-8',
        'SOAPAction: "urn:AC#executeCommand"',
      ];

      $context = stream_context_create([
        'http' => [
          'method' => 'POST',
          'header' => implode("\r\n", array_merge($headers, [
            'Authorization: Basic ' . base64_encode($soapUser . ':' . $soapPass),
          ])),
          'content' => $envelope,
          'timeout' => 10,
        ],
      ]);

      $attempts = 20;
      for ($i = 1; $i <= $attempts; $i++) {
        $resp = @file_get_contents($soapUrl, false, $context);
        if ($resp !== false) {
          return $resp;
        }

        $err = error_get_last();
        $msg = $err['message'] ?? 'request failed';

        if (strpos($msg, 'Connection refused') !== false) {
          usleep(500000);
          continue;
        }

        throw new RuntimeException("SOAP request failed: " . $msg);
      }

      throw new RuntimeException("SOAP request failed: worldserver SOAP not ready (timed out).");
    }

    function ensureSession(): void {
      if (session_status() !== PHP_SESSION_ACTIVE) {
        ini_set('session.use_strict_mode', '1');
        ini_set('session.use_only_cookies', '1');
        ini_set('session.cookie_httponly', '1');
        ini_set('session.cookie_samesite', 'Lax');
        if (isHttpsRequest()) {
          ini_set('session.cookie_secure', '1');
        }
        session_start();
      }
      if (empty($_SESSION['csrf'])) {
        $_SESSION['csrf'] = bin2hex(random_bytes(16));
      }
    }

    function csrfToken(): string {
      ensureSession();
      return (string)$_SESSION['csrf'];
    }

    function requireCsrf(): void {
      ensureSession();
      $sent = (string)($_POST['csrf'] ?? '');
      if ($sent === '' || !hash_equals((string)$_SESSION['csrf'], $sent)) {
        throw new RuntimeException("Invalid CSRF token. Refresh and try again.");
      }
    }

    function isLoggedIn(): bool {
      ensureSession();
      return !empty($_SESSION['account_id']) && !empty($_SESSION['username']);
    }

    function currentAccountId(): int {
      ensureSession();
      return (int)($_SESSION['account_id'] ?? 0);
    }

    function currentUsername(): string {
      ensureSession();
      return (string)($_SESSION['username'] ?? '');
    }

    handlePatchDownload();

    function logout(): void {
      ensureSession();
      $_SESSION = [];
      if (ini_get('session.use_cookies')) {
        $params = session_get_cookie_params();
        setcookie(session_name(), '', time() - 42000, $params['path'], $params['domain'], $params['secure'], $params['httponly']);
      }
      session_destroy();
    }

    function render(string $bodyHtml, string $flash = '', string $flashKind = 'info'): void {
      // We intentionally avoid using Blizzard trademarks/logos. This is a "2004-era Battle.net inspired" theme.
      $title = 'Account Management';
      $flashHtml = '';
      if ($flash !== '') {
        $flashHtml = '<div class="flash ' . htmlspecialchars($flashKind) . '">' . htmlspecialchars($flash) . '</div>';
      }

      $userChip = '';
      if (isLoggedIn()) {
        $userChip = '<div class="user">Signed in as <strong>' . htmlspecialchars(currentUsername()) . '</strong></div>';
      }

      $orbSvg = <<<SVG
      <svg viewBox="0 0 64 64" width="36" height="36" aria-hidden="true" focusable="false">
        <defs>
          <radialGradient id="g1" cx="30%" cy="28%" r="70%">
            <stop offset="0%" stop-color="#ffe7b0" stop-opacity="0.35"/>
            <stop offset="55%" stop-color="#4fc3f7" stop-opacity="0.18"/>
            <stop offset="100%" stop-color="#061225" stop-opacity="0"/>
          </radialGradient>
          <linearGradient id="g2" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#1b3e6a"/>
            <stop offset="100%" stop-color="#081428"/>
          </linearGradient>
        </defs>
        <circle cx="32" cy="32" r="28" fill="url(#g2)" stroke="#f0cf84" stroke-opacity="0.55" stroke-width="1.5"/>
        <circle cx="32" cy="32" r="26" fill="url(#g1)" />
        <path d="M18 35c4 8 20 11 28 2" fill="none" stroke="#8fd2ff" stroke-opacity="0.55" stroke-width="2" stroke-linecap="round"/>
        <path d="M22 28c6-10 20-12 24-2" fill="none" stroke="#ffe1a3" stroke-opacity="0.35" stroke-width="2" stroke-linecap="round"/>
      </svg>
      SVG;

      $tab = (string)($_GET['tab'] ?? (isLoggedIn() ? 'overview' : 'home'));
      $tabs = isLoggedIn()
        ? [
            'overview' => 'My Account',
            'announcements' => 'Announcements',
            'server' => 'Server Info',
            'characters' => 'Characters',
            'services' => 'Services',
            'store' => 'Store',
            'stats' => 'Stats',
            'arena' => 'Arena',
            'about' => 'About',
          ]
        : [
            'home' => 'Home',
            'announcements' => 'Announcements',
            'server' => 'Server Info',
            'about' => 'About',
          ];

      $tabLinks = '';
      foreach ($tabs as $k => $label) {
        $active = $k === $tab ? ' active' : '';
        $tabLinks .= '<a class="tab' . $active . '" href="/?tab=' . urlencode($k) . '">' . htmlspecialchars($label) . '</a>';
      }

      $masthead = '<div class="masthead"><h2>Grim Guzzler Battle.net</h2><p>Wrath-era portal for accounts, realm news, and community.</p></div>';

      echo <<<HTML
    <!doctype html>
    <html lang="en">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>{$title}</title>
      <style>
        :root { color-scheme: dark; }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          font-family: "Palatino Linotype", "Book Antiqua", Palatino, "Times New Roman", serif;
          color: #efe2c1;
          background:
            radial-gradient(1200px 700px at 50% -10%, rgba(48, 137, 245, .22), rgba(0,0,0,0)),
            radial-gradient(900px 500px at 30% 10%, rgba(255, 205, 105, .14), rgba(0,0,0,0)),
            radial-gradient(900px 600px at 70% 15%, rgba(255, 255, 255, .06), rgba(0,0,0,0)),
            linear-gradient(180deg, #091328, #02060c);
        }
        .noise:before {
          content:"";
          position: fixed;
          inset: 0;
          pointer-events: none;
          background-image:
            repeating-linear-gradient(0deg, rgba(255,255,255,.03), rgba(255,255,255,.03) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 4px);
          mix-blend-mode: overlay;
          opacity: .12;
        }
        a { color: #9bd7ff; }
        .wrap { max-width: 980px; margin: 0 auto; padding: 20px 14px 56px; }
        .topbar {
          display: flex; align-items: center; justify-content: space-between; gap: 10px;
          border: 1px solid rgba(255, 221, 148, .22);
          border-radius: 12px;
          background:
            linear-gradient(180deg, rgba(44, 29, 14, .55), rgba(12, 8, 4, .75)),
            linear-gradient(180deg, rgba(18, 55, 96, .35), rgba(7, 18, 35, .35));
          box-shadow: 0 24px 50px rgba(0,0,0,.45);
          padding: 12px 14px;
        }
        .masthead {
          margin-top: 12px;
          border-radius: 14px;
          padding: 18px 16px;
          border: 1px solid rgba(255, 221, 148, .18);
          background:
            linear-gradient(180deg, rgba(19, 52, 88, .55), rgba(9, 24, 44, .65)),
            linear-gradient(90deg, rgba(75, 48, 18, .35), rgba(20, 14, 7, .35));
          box-shadow: 0 22px 50px rgba(0,0,0,.45);
        }
        .masthead h2 { margin: 0; font-size: 18px; letter-spacing: .5px; color: #ffe1a3; font-family: "Georgia", "Times New Roman", serif; }
        .masthead p { margin: 6px 0 0; opacity: .8; font-size: 13px; }
        .brand {
          display:flex; align-items:center; gap: 12px;
        }
        .logo { width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; }
        .brand h1 { margin: 0; font-size: 15px; letter-spacing: .3px; color: #ffe1a3; font-family: "Georgia", "Times New Roman", serif; }
        .brand .sub { opacity: .75; font-size: 12px; margin-top: 2px; color: #cbb58f; }
        .user { font-size: 12px; opacity: .85; text-align: right; color: #d7c6a6; }
        .tabs {
          margin-top: 10px;
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
          padding: 8px;
          border: 1px solid rgba(255, 221, 148, .14);
          border-radius: 12px;
          background:
            linear-gradient(180deg, rgba(42, 28, 14, .70), rgba(12, 8, 4, .70));
          box-shadow: 0 20px 45px rgba(0,0,0,.35);
        }
        .tab {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 8px 10px;
          border-radius: 10px;
          border: 1px solid rgba(255, 221, 148, .12);
          background: rgba(0,0,0,.18);
          color: #efe2c1;
          text-decoration: none;
          font-weight: 700;
          letter-spacing: .15px;
          font-size: 12px;
        }
        .tab:hover { filter: brightness(1.05); }
        .tab.active {
          border-color: rgba(255, 221, 148, .28);
          background:
            linear-gradient(180deg, rgba(22, 86, 142, .50), rgba(10, 34, 60, .45));
          color: #ffe7b0;
        }
        .grid { display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 14px; }
        @media (min-width: 920px) { .grid { grid-template-columns: 1.25fr .75fr; } }
        .panel {
          border: 1px solid rgba(255, 221, 148, .18);
          border-radius: 12px;
          background:
            linear-gradient(180deg, rgba(38, 26, 14, .92), rgba(10, 7, 4, .92));
          box-shadow: 0 24px 55px rgba(0,0,0,.48);
          overflow: hidden;
        }
        .panel .hd {
          padding: 12px 14px;
          border-bottom: 1px solid rgba(255, 221, 148, .14);
          background:
            linear-gradient(180deg, rgba(20, 60, 108, .35), rgba(10, 24, 45, .10)),
            linear-gradient(180deg, rgba(60, 40, 18, .55), rgba(20, 14, 7, .35));
        }
        .panel .hd h2 { margin: 0; font-size: 13px; letter-spacing: .35px; color: #ffe1a3; text-transform: uppercase; font-family: "Georgia", "Times New Roman", serif; }
        .panel .bd { padding: 14px; }
        .flash {
          margin-top: 12px;
          border-radius: 10px;
          padding: 10px 12px;
          border: 1px solid rgba(255, 221, 148, .14);
          background: rgba(0,0,0,.18);
        }
        .flash.ok { border-color: rgba(34,197,94,.4); }
        .flash.err { border-color: rgba(239,68,68,.4); }
        label { display:block; margin: 10px 0 6px; font-size: 12px; opacity: .9; color: #d7c6a6; }
        input, select, textarea {
          width: 100%;
          padding: 10px 12px;
          border-radius: 10px;
          border: 1px solid rgba(255, 221, 148, .16);
          background: rgba(0,0,0,.28);
          color: #efe2c1;
        }
        textarea { min-height: 140px; resize: vertical; }
        .btn {
          display:inline-flex; align-items:center; justify-content:center;
          gap: 8px;
          padding: 9px 12px;
          border-radius: 10px;
          border: 1px solid rgba(255, 221, 148, .22);
          background:
            linear-gradient(180deg, rgba(22, 86, 142, .70), rgba(10, 34, 60, .75));
          color: #ffe7b0;
          font-weight: 700;
          cursor: pointer;
        }
        .btn:hover { filter: brightness(1.05); }
        .btn.secondary { background: rgba(0,0,0,.18); border-color: rgba(255, 221, 148, .14); font-weight: 600; color: #efe2c1; }
        .btn.danger { background: linear-gradient(180deg, rgba(160, 22, 22, .75), rgba(80, 12, 12, .75)); border-color: rgba(239, 68, 68, .35); color: #ffe1a3; }
        .btn svg { width: 14px; height: 14px; opacity: .95; }
        .classpill {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 18px;
          height: 18px;
          border-radius: 6px;
          border: 1px solid rgba(255, 221, 148, .18);
          background:
            radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(0,0,0,0) 60%),
            linear-gradient(180deg, color-mix(in srgb, var(--c) 55%, #000 45%), rgba(0,0,0,.55));
          color: #fff;
          font-weight: 900;
          font-size: 11px;
          text-shadow: 0 1px 2px rgba(0,0,0,.6);
          vertical-align: middle;
          margin-right: 6px;
        }
        .classpill.unk { --c: #64748b; }
        .classpill.war { --c: #C79C6E; }  /* Warrior */
        .classpill.pal { --c: #F58CBA; }  /* Paladin */
        .classpill.hun { --c: #ABD473; }  /* Hunter */
        .classpill.rog { --c: #FFF569; }  /* Rogue */
        .classpill.pri { --c: #FFFFFF; }  /* Priest */
        .classpill.dkn { --c: #C41F3B; }  /* Death Knight */
        .classpill.sha { --c: #0070DE; }  /* Shaman */
        .classpill.mag { --c: #69CCF0; }  /* Mage */
        .classpill.wlk { --c: #9482C9; }  /* Warlock */
        .classpill.dru { --c: #FF7D0A; }  /* Druid */
        .row { display:flex; gap: 10px; align-items: center; }
        .row > * { flex: 1; }
        .table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .table th, .table td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,.08); vertical-align: top; }
        .table th { text-align: left; color: #ffe1a3; font-weight: 700; letter-spacing: .25px; }
        .muted { opacity: .75; color: #cbb58f; }
        .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(255, 221, 148, .14); background: rgba(0,0,0,.18); }
        .divider { height: 1px; background: rgba(255, 221, 148, .12); margin: 16px 0; }
        .kpi { display:flex; gap: 10px; flex-wrap: wrap; }
        .kpi .card { flex: 1; min-width: 160px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255, 221, 148, .14); background: rgba(0,0,0,.18); }
        .kpi .val { font-size: 20px; font-weight: 800; color: #9bd7ff; margin-top: 4px; }
        .post { border: 1px solid rgba(255, 221, 148, .14); border-radius: 10px; padding: 10px 12px; background: rgba(0,0,0,.18); margin-bottom: 10px; }
        .post-title { font-weight: 700; color: #ffe1a3; }
        .post-meta { font-size: 11px; opacity: .7; margin-top: 4px; }
        .post-body { margin-top: 8px; line-height: 1.6; }
        .post.admin {
          border-color: rgba(90, 200, 255, .55);
          background:
            linear-gradient(180deg, rgba(16, 65, 104, .55), rgba(8, 24, 44, .55)),
            rgba(0,0,0,.18);
          box-shadow: 0 12px 28px rgba(0,0,0,.35);
        }
        .badge {
          display:inline-block;
          padding: 2px 8px;
          border-radius: 999px;
          border: 1px solid rgba(255, 221, 148, .14);
          background: rgba(0,0,0,.18);
          font-size: 11px;
          font-weight: 700;
        }
        .badge.admin {
          border-color: rgba(90, 200, 255, .6);
          color: #bfe6ff;
          background: rgba(12, 38, 64, .55);
        }
        .forum-grid { display: grid; gap: 12px; }
        .forum-item {
          border: 1px solid rgba(255, 221, 148, .14);
          border-radius: 10px;
          padding: 10px 12px;
          background: rgba(0,0,0,.18);
        }
        .forum-title { font-weight: 700; color: #ffe1a3; }
        .forum-meta { font-size: 11px; opacity: .7; margin-top: 4px; }
        .forum-row { display: grid; grid-template-columns: 1fr 120px 140px; gap: 10px; align-items: center; }
        .forum-cell { font-size: 12px; }
        .forum-cell.right { text-align: right; }
        .avatar {
          width: 34px; height: 34px; border-radius: 50%;
          display: inline-flex; align-items: center; justify-content: center;
          background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.2), rgba(0,0,0,.2)),
                      linear-gradient(180deg, rgba(80, 120, 170, .6), rgba(20, 40, 70, .6));
          border: 1px solid rgba(255, 221, 148, .22);
          color: #ffe1a3; font-weight: 700; font-size: 12px;
          margin-right: 10px;
        }
        .post-row { display: flex; gap: 10px; align-items: flex-start; }
        .post-content { flex: 1; }
        @media (max-width: 780px) {
          .forum-row { grid-template-columns: 1fr; }
          .forum-cell.right { text-align: left; }
        }
        .foot { margin-top: 16px; font-size: 12px; opacity: .7; }
      </style>
    </head>
    <body class="noise">
      <div class="wrap">
        <div class="topbar">
          <div class="brand">
            <div class="logo">{$orbSvg}</div>
            <div>
              <h1>{$title}</h1>
              <div class="sub">Grim Guzzler • Wrath 3.3.5a</div>
            </div>
          </div>
          {$userChip}
        </div>
        {$masthead}
        <nav class="tabs" aria-label="Primary">
          {$tabLinks}
        </nav>
        {$flashHtml}
        {$bodyHtml}
        <div class="foot">Tip: characters must be offline for rename/race change/unstuck to apply safely.</div>
      </div>
    </body>
    </html>
    HTML;
      exit;
    }

    function ensureStatsTable(PDO $pdo): void {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $pdo->exec(
        "CREATE TABLE IF NOT EXISTS {$charDb}.web_stats_daily (" .
        "snapshot_date DATE NOT NULL," .
        "guid INT UNSIGNED NOT NULL," .
        "name VARCHAR(12) NOT NULL," .
        "class TINYINT UNSIGNED NOT NULL," .
        "level TINYINT UNSIGNED NOT NULL," .
        "total_kills INT UNSIGNED NOT NULL," .
        "PRIMARY KEY (snapshot_date, guid)," .
        "KEY guid_idx (guid)," .
        "KEY date_idx (snapshot_date)" .
        ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4"
      );
      // Migrate older table versions (MySQL compatibility: avoid ADD COLUMN IF NOT EXISTS).
      $stmt = $pdo->prepare(
        "SELECT COUNT(*) AS c FROM information_schema.COLUMNS " .
        "WHERE TABLE_SCHEMA = :db AND TABLE_NAME = 'web_stats_daily' AND COLUMN_NAME = 'class'"
      );
      $stmt->execute([':db' => $charDb]);
      $has = (int)$stmt->fetch()['c'];
      if ($has === 0) {
        $pdo->exec("ALTER TABLE {$charDb}.web_stats_daily ADD COLUMN class TINYINT UNSIGNED NOT NULL DEFAULT 0 AFTER name");
      }
    }

    function classPill(int $class): string {
      $map = [
        1 => ['war', 'W'],
        2 => ['pal', 'P'],
        3 => ['hun', 'H'],
        4 => ['rog', 'R'],
        5 => ['pri', 'P'],
        6 => ['dkn', 'D'],
        7 => ['sha', 'S'],
        8 => ['mag', 'M'],
        9 => ['wlk', 'W'],
        11 => ['dru', 'D'],
      ];
      $m = $map[$class] ?? ['unk', '?'];
      return '<span class="classpill ' . $m[0] . '">' . $m[1] . '</span>';
    }

    function getRealmInfo(PDO $pdo): array {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $realmId = (int)envOrDefault('REALM_ID', '1');
      $stmt = $pdo->prepare("SELECT id, name, address, port FROM {$authDb}.realmlist WHERE id = :id LIMIT 1");
      $stmt->execute([':id' => $realmId]);
      $row = $stmt->fetch();
      if (!$row) {
        return ['name' => 'Unknown', 'address' => '', 'port' => 0];
      }
      return [
        'name' => (string)$row['name'],
        'address' => (string)$row['address'],
        'port' => (int)$row['port'],
      ];
    }

    function ensureForumTables(PDO $pdo): void {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $pdo->exec(
        "CREATE TABLE IF NOT EXISTS {$authDb}.web_forum_categories (" .
        "id INT UNSIGNED NOT NULL AUTO_INCREMENT," .
        "name VARCHAR(80) NOT NULL," .
        "description VARCHAR(255) NOT NULL," .
        "sort_order INT NOT NULL DEFAULT 0," .
        "is_locked TINYINT(1) NOT NULL DEFAULT 0," .
        "is_hidden TINYINT(1) NOT NULL DEFAULT 0," .
        "created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP," .
        "PRIMARY KEY (id)," .
        "KEY sort_idx (sort_order)" .
        ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4"
      );
      $pdo->exec(
        "CREATE TABLE IF NOT EXISTS {$authDb}.web_forum_threads (" .
        "id INT UNSIGNED NOT NULL AUTO_INCREMENT," .
        "category_id INT UNSIGNED NOT NULL," .
        "title VARCHAR(140) NOT NULL," .
        "author VARCHAR(32) NOT NULL," .
        "author_account_id INT UNSIGNED NOT NULL," .
        "created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP," .
        "updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP," .
        "is_locked TINYINT(1) NOT NULL DEFAULT 0," .
        "is_pinned TINYINT(1) NOT NULL DEFAULT 0," .
        "is_deleted TINYINT(1) NOT NULL DEFAULT 0," .
        "PRIMARY KEY (id)," .
        "KEY cat_idx (category_id, updated_at)," .
        "KEY pinned_idx (category_id, is_pinned, updated_at)" .
        ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4"
      );
      $pdo->exec(
        "CREATE TABLE IF NOT EXISTS {$authDb}.web_forum_posts (" .
        "id INT UNSIGNED NOT NULL AUTO_INCREMENT," .
        "thread_id INT UNSIGNED NOT NULL," .
        "author VARCHAR(32) NOT NULL," .
        "author_account_id INT UNSIGNED NOT NULL," .
        "body TEXT NOT NULL," .
        "created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP," .
        "updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP," .
        "is_deleted TINYINT(1) NOT NULL DEFAULT 0," .
        "PRIMARY KEY (id)," .
        "KEY thread_idx (thread_id, created_at)" .
        ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4"
      );
    }

    function seedForumCategories(PDO $pdo): void {
      ensureForumTables($pdo);
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $count = (int)$pdo->query("SELECT COUNT(*) AS c FROM {$authDb}.web_forum_categories")->fetch()['c'];
      if ($count > 0) {
        return;
      }
      $defaults = [
        ['name' => 'General Discussion', 'description' => 'Talk about the realm, stories, and raids.', 'sort' => 10],
        ['name' => 'Bug Reports', 'description' => 'Report issues and odd behavior you notice.', 'sort' => 20],
        ['name' => 'Guild & LFG', 'description' => 'Find groups, guilds, and arena partners.', 'sort' => 30],
      ];
      $stmt = $pdo->prepare(
        "INSERT INTO {$authDb}.web_forum_categories (name, description, sort_order) VALUES (:n, :d, :s)"
      );
      foreach ($defaults as $d) {
        $stmt->execute([':n' => $d['name'], ':d' => $d['description'], ':s' => $d['sort']]);
      }
    }

    function listForumCategories(PDO $pdo): array {
      seedForumCategories($pdo);
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->query(
        "SELECT c.id, c.name, c.description, c.sort_order, c.is_locked, c.is_hidden, " .
        "(SELECT COUNT(*) FROM {$authDb}.web_forum_threads t WHERE t.category_id = c.id AND t.is_deleted = 0) AS threads, " .
        "(SELECT COUNT(*) FROM {$authDb}.web_forum_posts p " .
          "JOIN {$authDb}.web_forum_threads t2 ON t2.id = p.thread_id " .
          "WHERE t2.category_id = c.id AND p.is_deleted = 0 AND t2.is_deleted = 0) AS posts " .
        "FROM {$authDb}.web_forum_categories c " .
        "WHERE c.is_hidden = 0 " .
        "ORDER BY c.sort_order ASC, c.id ASC"
      );
      return $stmt->fetchAll();
    }

    function getForumCategory(PDO $pdo, int $categoryId): array {
      seedForumCategories($pdo);
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare(
        "SELECT id, name, description, is_locked, is_hidden FROM {$authDb}.web_forum_categories WHERE id = :id LIMIT 1"
      );
      $stmt->execute([':id' => $categoryId]);
      $row = $stmt->fetch();
      if (!$row || (int)$row['is_hidden'] === 1) {
        throw new RuntimeException("Forum category not found.");
      }
      return $row;
    }

    function countForumThreads(PDO $pdo, int $categoryId, string $query = ''): int {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $sql = "SELECT COUNT(*) AS c FROM {$authDb}.web_forum_threads t " .
        "WHERE t.category_id = :c AND t.is_deleted = 0";
      $params = [':c' => $categoryId];
      if ($query !== '') {
        $sql .= " AND t.title LIKE :q";
        $params[':q'] = '%' . $query . '%';
      }
      $stmt = $pdo->prepare($sql);
      $stmt->execute($params);
      $row = $stmt->fetch();
      return $row ? (int)$row['c'] : 0;
    }

    function listForumThreadsPage(PDO $pdo, int $categoryId, int $limit, int $offset, string $query = ''): array {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $sql =
        "SELECT t.id, t.title, t.author, t.author_account_id, t.created_at, t.updated_at, t.is_locked, t.is_pinned, " .
        "(SELECT COUNT(*) FROM {$authDb}.web_forum_posts p WHERE p.thread_id = t.id AND p.is_deleted = 0) AS replies, " .
        "(SELECT p2.author FROM {$authDb}.web_forum_posts p2 WHERE p2.thread_id = t.id AND p2.is_deleted = 0 ORDER BY p2.created_at DESC, p2.id DESC LIMIT 1) AS last_author, " .
        "(SELECT p2.created_at FROM {$authDb}.web_forum_posts p2 WHERE p2.thread_id = t.id AND p2.is_deleted = 0 ORDER BY p2.created_at DESC, p2.id DESC LIMIT 1) AS last_post_at " .
        "FROM {$authDb}.web_forum_threads t " .
        "WHERE t.category_id = :c AND t.is_deleted = 0";
      $params = [':c' => $categoryId];
      if ($query !== '') {
        $sql .= " AND t.title LIKE :q";
        $params[':q'] = '%' . $query . '%';
      }
      $sql .= " ORDER BY t.is_pinned DESC, t.updated_at DESC, t.id DESC LIMIT :l OFFSET :o";
      $stmt = $pdo->prepare($sql);
      foreach ($params as $k => $v) {
        $stmt->bindValue($k, $v, PDO::PARAM_STR);
      }
      $stmt->bindValue(':l', $limit, PDO::PARAM_INT);
      $stmt->bindValue(':o', $offset, PDO::PARAM_INT);
      $stmt->execute();
      return $stmt->fetchAll();
    }

    function getForumThread(PDO $pdo, int $threadId): array {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare(
        "SELECT t.id, t.category_id, t.title, t.author, t.author_account_id, t.created_at, t.updated_at, t.is_locked, t.is_pinned " .
        "FROM {$authDb}.web_forum_threads t WHERE t.id = :id AND t.is_deleted = 0 LIMIT 1"
      );
      $stmt->execute([':id' => $threadId]);
      $row = $stmt->fetch();
      if (!$row) {
        throw new RuntimeException("Thread not found.");
      }
      return $row;
    }

    function countForumPosts(PDO $pdo, int $threadId): int {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare(
        "SELECT COUNT(*) AS c FROM {$authDb}.web_forum_posts WHERE thread_id = :t AND is_deleted = 0"
      );
      $stmt->execute([':t' => $threadId]);
      $row = $stmt->fetch();
      return $row ? (int)$row['c'] : 0;
    }

    function listForumPostsPage(PDO $pdo, int $threadId, int $limit, int $offset): array {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare(
        "SELECT id, author, author_account_id, body, created_at, updated_at " .
        "FROM {$authDb}.web_forum_posts " .
        "WHERE thread_id = :t AND is_deleted = 0 " .
        "ORDER BY created_at ASC, id ASC " .
        "LIMIT :l OFFSET :o"
      );
      $stmt->bindValue(':t', $threadId, PDO::PARAM_INT);
      $stmt->bindValue(':l', $limit, PDO::PARAM_INT);
      $stmt->bindValue(':o', $offset, PDO::PARAM_INT);
      $stmt->execute();
      return $stmt->fetchAll();
    }

    function adminAccountIds(PDO $pdo): array {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $minLevel = (int)envOrDefault('PORTAL_ADMIN_GMLEVEL', '3');
      $stmt = $pdo->prepare("SELECT id FROM {$authDb}.account_access WHERE gmlevel >= :g");
      $stmt->execute([':g' => $minLevel]);
      $ids = [];
      foreach ($stmt->fetchAll() as $r) {
        $ids[(int)$r['id']] = true;
      }
      return $ids;
    }

    function getAccountProfile(PDO $pdo, int $accountId): array {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $stmt = $pdo->prepare(
        "SELECT name, class, level FROM {$charDb}.characters WHERE account = :a ORDER BY level DESC, name ASC LIMIT 1"
      );
      $stmt->execute([':a' => $accountId]);
      $top = $stmt->fetch() ?: ['name' => '', 'class' => 0, 'level' => 0];
      $countStmt = $pdo->prepare("SELECT COUNT(*) AS c FROM {$charDb}.characters WHERE account = :a");
      $countStmt->execute([':a' => $accountId]);
      $count = (int)$countStmt->fetch()['c'];
      return [
        'top_name' => (string)$top['name'],
        'top_class' => (int)$top['class'],
        'top_level' => (int)$top['level'],
        'total_chars' => $count,
      ];
    }

    function countForumSearchAll(PDO $pdo, string $query): int {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare(
        "SELECT COUNT(DISTINCT t.id) AS c " .
        "FROM {$authDb}.web_forum_threads t " .
        "LEFT JOIN {$authDb}.web_forum_posts p ON p.thread_id = t.id AND p.is_deleted = 0 " .
        "WHERE t.is_deleted = 0 AND (t.title LIKE :q OR p.body LIKE :q)"
      );
      $stmt->execute([':q' => '%' . $query . '%']);
      $row = $stmt->fetch();
      return $row ? (int)$row['c'] : 0;
    }

    function listForumSearchAll(PDO $pdo, string $query, int $limit, int $offset): array {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare(
        "SELECT t.id, t.category_id, t.title, t.author, t.updated_at, t.is_locked, t.is_pinned, " .
        "(SELECT COUNT(*) FROM {$authDb}.web_forum_posts p2 WHERE p2.thread_id = t.id AND p2.is_deleted = 0) AS replies, " .
        "(SELECT p2.author FROM {$authDb}.web_forum_posts p2 WHERE p2.thread_id = t.id AND p2.is_deleted = 0 ORDER BY p2.created_at DESC, p2.id DESC LIMIT 1) AS last_author, " .
        "(SELECT p2.created_at FROM {$authDb}.web_forum_posts p2 WHERE p2.thread_id = t.id AND p2.is_deleted = 0 ORDER BY p2.created_at DESC, p2.id DESC LIMIT 1) AS last_post_at " .
        "FROM {$authDb}.web_forum_threads t " .
        "LEFT JOIN {$authDb}.web_forum_posts p ON p.thread_id = t.id AND p.is_deleted = 0 " .
        "WHERE t.is_deleted = 0 AND (t.title LIKE :q OR p.body LIKE :q) " .
        "GROUP BY t.id " .
        "ORDER BY t.is_pinned DESC, t.updated_at DESC, t.id DESC " .
        "LIMIT :l OFFSET :o"
      );
      $stmt->bindValue(':q', '%' . $query . '%', PDO::PARAM_STR);
      $stmt->bindValue(':l', $limit, PDO::PARAM_INT);
      $stmt->bindValue(':o', $offset, PDO::PARAM_INT);
      $stmt->execute();
      return $stmt->fetchAll();
    }

    function createForumThread(PDO $pdo, int $categoryId, string $title, string $body, string $author, int $authorId): void {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $pdo->beginTransaction();
      try {
        $stmt = $pdo->prepare(
          "INSERT INTO {$authDb}.web_forum_threads (category_id, title, author, author_account_id) " .
          "VALUES (:c, :t, :a, :id)"
        );
        $stmt->execute([':c' => $categoryId, ':t' => $title, ':a' => $author, ':id' => $authorId]);
        $threadId = (int)$pdo->lastInsertId();
        $stmt2 = $pdo->prepare(
          "INSERT INTO {$authDb}.web_forum_posts (thread_id, author, author_account_id, body) " .
          "VALUES (:t, :a, :id, :b)"
        );
        $stmt2->execute([':t' => $threadId, ':a' => $author, ':id' => $authorId, ':b' => $body]);
        $pdo->commit();
      } catch (Throwable $e) {
        if ($pdo->inTransaction()) $pdo->rollBack();
        throw $e;
      }
    }

    function replyToForumThread(PDO $pdo, int $threadId, string $body, string $author, int $authorId): void {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $pdo->beginTransaction();
      try {
        $stmt = $pdo->prepare(
          "INSERT INTO {$authDb}.web_forum_posts (thread_id, author, author_account_id, body) " .
          "VALUES (:t, :a, :id, :b)"
        );
        $stmt->execute([':t' => $threadId, ':a' => $author, ':id' => $authorId, ':b' => $body]);
        $stmt2 = $pdo->prepare("UPDATE {$authDb}.web_forum_threads SET updated_at = CURRENT_TIMESTAMP WHERE id = :t");
        $stmt2->execute([':t' => $threadId]);
        $pdo->commit();
      } catch (Throwable $e) {
        if ($pdo->inTransaction()) $pdo->rollBack();
        throw $e;
      }
    }

    function setForumThreadFlag(PDO $pdo, int $threadId, string $field, int $value): void {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $allowed = ['is_locked', 'is_pinned', 'is_deleted'];
      if (!in_array($field, $allowed, true)) {
        throw new RuntimeException("Invalid moderation action.");
      }
      $stmt = $pdo->prepare("UPDATE {$authDb}.web_forum_threads SET {$field} = :v WHERE id = :t");
      $stmt->execute([':v' => $value, ':t' => $threadId]);
    }

    function deleteForumPost(PDO $pdo, int $postId): void {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare("UPDATE {$authDb}.web_forum_posts SET is_deleted = 1 WHERE id = :p");
      $stmt->execute([':p' => $postId]);
    }

    function validateForumTitle(string $title): string {
      $title = trim($title);
      if ($title === '' || strlen($title) < 3) {
        throw new RuntimeException("Thread title is too short.");
      }
      if (strlen($title) > 140) {
        throw new RuntimeException("Thread title is too long.");
      }
      return $title;
    }

    function validateForumBody(string $body): string {
      $body = trim($body);
      if ($body === '' || strlen($body) < 3) {
        throw new RuntimeException("Post body is too short.");
      }
      if (strlen($body) > 8000) {
        throw new RuntimeException("Post body is too long.");
      }
      return $body;
    }

    function ensureAnnouncementsTable(PDO $pdo): void {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $pdo->exec(
        "CREATE TABLE IF NOT EXISTS {$authDb}.web_announcements (" .
        "id INT UNSIGNED NOT NULL AUTO_INCREMENT," .
        "title VARCHAR(140) NOT NULL," .
        "body TEXT NOT NULL," .
        "author VARCHAR(32) NOT NULL," .
        "created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP," .
        "updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP," .
        "PRIMARY KEY (id)," .
        "KEY created_idx (created_at)" .
        ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4"
      );
    }

    function isAdmin(PDO $pdo, int $accountId): bool {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $minLevel = (int)envOrDefault('PORTAL_ADMIN_GMLEVEL', '3');
      $stmt = $pdo->prepare("SELECT MAX(gmlevel) AS gm FROM {$authDb}.account_access WHERE id = :id");
      $stmt->execute([':id' => $accountId]);
      $row = $stmt->fetch();
      $gm = $row ? (int)$row['gm'] : 0;
      return $gm >= $minLevel;
    }

    function listAnnouncements(PDO $pdo, int $limit = 10): array {
      ensureAnnouncementsTable($pdo);
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare(
        "SELECT id, title, body, author, created_at, updated_at " .
        "FROM {$authDb}.web_announcements " .
        "ORDER BY created_at DESC, id DESC " .
        "LIMIT :l"
      );
      $stmt->bindValue(':l', $limit, PDO::PARAM_INT);
      $stmt->execute();
      return $stmt->fetchAll();
    }

    function renderAnnouncementsList(array $announcements, string $emptyText): string {
      if (!$announcements) {
        return '<div class="muted">' . htmlspecialchars($emptyText) . '</div>';
      }
      $out = '';
      foreach ($announcements as $a) {
        $title = htmlspecialchars((string)($a['title'] ?? ''));
        $body = nl2br(htmlspecialchars((string)($a['body'] ?? '')));
        $author = htmlspecialchars((string)($a['author'] ?? ''));
        $created = htmlspecialchars((string)($a['created_at'] ?? ''));
        $out .= '<div class="post">' .
          '<div class="post-title">' . $title . '</div>' .
          '<div class="post-meta">Posted by ' . $author . ' • ' . $created . '</div>' .
          '<div class="post-body">' . $body . '</div>' .
          '</div>';
      }
      return $out;
    }

    function validateAnnouncementTitle(string $title): string {
      $title = trim($title);
      if ($title === '' || strlen($title) < 3) {
        throw new RuntimeException("Announcement title is too short.");
      }
      if (strlen($title) > 140) {
        throw new RuntimeException("Announcement title is too long.");
      }
      return $title;
    }

    function validateAnnouncementBody(string $body): string {
      $body = trim($body);
      if ($body === '' || strlen($body) < 3) {
        throw new RuntimeException("Announcement body is too short.");
      }
      if (strlen($body) > 4000) {
        throw new RuntimeException("Announcement body is too long.");
      }
      return $body;
    }

    function createAnnouncement(PDO $pdo, string $title, string $body, string $author): void {
      ensureAnnouncementsTable($pdo);
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare(
        "INSERT INTO {$authDb}.web_announcements (title, body, author) VALUES (:t, :b, :a)"
      );
      $stmt->execute([':t' => $title, ':b' => $body, ':a' => $author]);
    }

    function deleteAnnouncement(PDO $pdo, int $id): void {
      ensureAnnouncementsTable($pdo);
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare("DELETE FROM {$authDb}.web_announcements WHERE id = :id");
      $stmt->execute([':id' => $id]);
    }

    function storeTokenItemId(): int {
      return (int)envOrDefault('STORE_TOKEN_ITEM_ID', '90000');
    }

    function storeItems(): array {
      // Extend this list with more vanity items as needed.
      return [
        ['id' => 35227, 'name' => 'Goblin Weather Machine', 'cost' => 15, 'note' => 'Vanity toy.'],
        ['id' => 33219, 'name' => 'Goblin Gumbo Kettle', 'cost' => 10, 'note' => 'Fun/cosmetic.'],
        ['id' => 32542, 'name' => 'Imp in a Ball', 'cost' => 20, 'note' => 'Vanity.'],
      ];
    }

    function isBotCharacter(PDO $pdo, string $charName): bool {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $stmt = $pdo->prepare("SELECT 1 FROM {$charDb}.playerbots_names WHERE UPPER(name) = UPPER(:n) LIMIT 1");
      $stmt->execute([':n' => $charName]);
      return (bool)$stmt->fetchColumn();
    }

    function tokenCount(PDO $pdo, int $charGuid): int {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $tokenId = storeTokenItemId();
      $stmt = $pdo->prepare(
        "SELECT COALESCE(SUM(ii.count), 0) AS c " .
        "FROM {$charDb}.character_inventory ci " .
        "JOIN {$charDb}.item_instance ii ON ii.guid = ci.item " .
        "WHERE ci.guid = :g AND ii.itemEntry = :e"
      );
      $stmt->execute([':g' => $charGuid, ':e' => $tokenId]);
      return (int)$stmt->fetchColumn();
    }

    function deductTokens(PDO $pdo, int $charGuid, int $amount): void {
      if ($amount <= 0) return;
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $tokenId = storeTokenItemId();

      $stmt = $pdo->prepare(
        "SELECT ii.guid, ii.count " .
        "FROM {$charDb}.character_inventory ci " .
        "JOIN {$charDb}.item_instance ii ON ii.guid = ci.item " .
        "WHERE ci.guid = :g AND ii.itemEntry = :e " .
        "ORDER BY ii.count DESC, ii.guid ASC"
      );
      $stmt->execute([':g' => $charGuid, ':e' => $tokenId]);
      $rows = $stmt->fetchAll();

      $remaining = $amount;
      foreach ($rows as $r) {
        if ($remaining <= 0) break;
        $itemGuid = (int)$r['guid'];
        $count = (int)$r['count'];
        if ($count <= 0) continue;

        if ($count > $remaining) {
          $upd = $pdo->prepare("UPDATE {$charDb}.item_instance SET count = count - :d WHERE guid = :i");
          $upd->execute([':d' => $remaining, ':i' => $itemGuid]);
          $remaining = 0;
          break;
        }

        $delInv = $pdo->prepare("DELETE FROM {$charDb}.character_inventory WHERE item = :i");
        $delInv->execute([':i' => $itemGuid]);
        $delItem = $pdo->prepare("DELETE FROM {$charDb}.item_instance WHERE guid = :i");
        $delItem->execute([':i' => $itemGuid]);
        $remaining -= $count;
      }

      if ($remaining > 0) {
        throw new RuntimeException("Insufficient tokens.");
      }
    }

    function getSnapshotInfo(PDO $pdo): array {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      ensureStatsTable($pdo);
      $last = $pdo->query("SELECT MAX(snapshot_date) AS d FROM {$charDb}.web_stats_daily")->fetch();
      $d = $last && $last['d'] ? (string)$last['d'] : '';
      $rows = 0;
      if ($d !== '') {
        $stmt = $pdo->prepare("SELECT COUNT(*) AS c FROM {$charDb}.web_stats_daily WHERE snapshot_date = :d");
        $stmt->execute([':d' => $d]);
        $rows = (int)$stmt->fetch()['c'];
      }
      return ['date' => $d, 'rows' => $rows];
    }

    function getStats(PDO $pdo): array {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      ensureStatsTable($pdo);

      $playersOnline = (int)$pdo->query("SELECT COUNT(*) AS c FROM {$charDb}.characters WHERE online = 1")->fetch()['c'];

      $topKills = [];
      $topLevels = [];

      // These depend on the periodic snapshot job. If it hasn't run yet, tables will be empty.
      $topKillsStmt = $pdo->query(
        "SELECT MAX(name) AS name, MAX(class) AS class, MAX(level) AS level, (MAX(total_kills) - MIN(total_kills)) AS gained " .
        "FROM {$charDb}.web_stats_daily " .
        "WHERE snapshot_date >= (CURRENT_DATE - INTERVAL 7 DAY) " .
        "GROUP BY guid " .
        "HAVING gained > 0 " .
        "ORDER BY gained DESC " .
        "LIMIT 10"
      );
      $topKills = $topKillsStmt->fetchAll();

      $topLevelsStmt = $pdo->query(
        "SELECT MAX(name) AS name, MAX(class) AS class, MAX(level) AS level, (MAX(level) - MIN(level)) AS gained " .
        "FROM {$charDb}.web_stats_daily " .
        "WHERE snapshot_date >= (CURRENT_DATE - INTERVAL 7 DAY) " .
        "GROUP BY guid " .
        "HAVING gained > 0 " .
        "ORDER BY gained DESC " .
        "LIMIT 10"
      );
      $topLevels = $topLevelsStmt->fetchAll();

      return [
        'players_online' => $playersOnline,
        'top_kills' => $topKills,
        'top_levels' => $topLevels,
      ];
    }

    function listCharacters(PDO $pdo, int $accountId): array {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $stmt = $pdo->prepare(
        "SELECT guid, name, race, class, level, online, at_login, zone, map " .
        "FROM {$charDb}.characters WHERE account = :a ORDER BY level DESC, name ASC"
      );
      $stmt->execute([':a' => $accountId]);
      return $stmt->fetchAll();
    }

    function characterBelongsTo(PDO $pdo, int $accountId, int $guid): array {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $stmt = $pdo->prepare(
        "SELECT guid, account, name, race, class, level, online, at_login, zone, map " .
        "FROM {$charDb}.characters WHERE guid = :g LIMIT 1"
      );
      $stmt->execute([':g' => $guid]);
      $row = $stmt->fetch();
      if (!$row || (int)$row['account'] !== $accountId) {
        throw new RuntimeException("Character not found.");
      }
      return $row;
    }

    function setAtLoginFlag(PDO $pdo, int $guid, int $bit): void {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $stmt = $pdo->prepare("UPDATE {$charDb}.characters SET at_login = (at_login | :bit) WHERE guid = :g");
      $stmt->execute([':bit' => $bit, ':g' => $guid]);
    }

    function getTeamFactionForRace(int $race): int {
      // AzerothCore: graveyard_zone.Faction is 469 (Alliance), 67 (Horde), 0 (any)
      $alliance = [1, 3, 4, 7, 11];
      return in_array($race, $alliance, true) ? 469 : 67;
    }

    function unstuckToGraveyard(PDO $pdo, array $char): void {
      $worldDb = dbName('DB_WORLD_DB', 'acore_world');
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');

      $zone = (int)$char['zone'];
      $race = (int)$char['race'];
      $guid = (int)$char['guid'];
      $faction = getTeamFactionForRace($race);

      $stmt = $pdo->prepare(
        "SELECT g.Map AS map, g.x, g.y, g.z " .
        "FROM {$worldDb}.graveyard_zone gz " .
        "JOIN {$worldDb}.game_graveyard g ON g.ID = gz.ID " .
        "WHERE gz.GhostZone = :z AND (gz.Faction = 0 OR gz.Faction = :f) " .
        "ORDER BY (gz.Faction = 0) ASC, gz.ID ASC " .
        "LIMIT 1"
      );
      $stmt->execute([':z' => $zone, ':f' => $faction]);
      $gy = $stmt->fetch();
      if (!$gy) {
        throw new RuntimeException("No graveyard mapping found for zone {$zone}.");
      }

      $upd = $pdo->prepare(
        "UPDATE {$charDb}.characters " .
        "SET map = :map, position_x = :x, position_y = :y, position_z = :z, " .
        "trans_x = 0, trans_y = 0, trans_z = 0, trans_o = 0, transguid = 0 " .
        "WHERE guid = :g"
      );
      $upd->execute([
        ':map' => (int)$gy['map'],
        ':x' => (float)$gy['x'],
        ':y' => (float)$gy['y'],
        ':z' => (float)$gy['z'],
        ':g' => $guid,
      ]);
    }

    function renderLoginPage(array $stats, array $realm, array $snap, array $announcements, string $flash = '', string $flashKind = 'info'): void {
      $csrf = htmlspecialchars(csrfToken());
      $online = (int)$stats['players_online'];

      $iconLogin = '<svg viewBox="0 0 24 24" fill="none"><path d="M14 7V5a2 2 0 0 0-2-2H5v18h7a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M21 12H11m0 0 3-3m-3 3 3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';

      $annLead = trim(envOrDefault('PORTAL_ANNOUNCEMENTS', 'Welcome to Grim Guzzler.'));
      $annLeadHtml = nl2br(htmlspecialchars($annLead));
      $announcementsHtml = renderAnnouncementsList($announcements, 'No announcements yet.');
      $realmName = htmlspecialchars((string)($realm['name'] ?? 'Unknown'));
      $realmAddr = htmlspecialchars((string)($realm['address'] ?? ''));
      $realmPort = (int)($realm['port'] ?? 0);
      $snapshotDate = htmlspecialchars((string)($snap['date'] ?? ''));
      $snapshotRows = (int)($snap['rows'] ?? 0);

      $githubRepo = envOrDefault('PORTAL_GITHUB_REPO', 'RovxBot/homelab-infra');
      $githubBranch = envOrDefault('PORTAL_GITHUB_BRANCH', 'main');
      $githubRepoSafe = preg_match('/^[A-Za-z0-9_.-]+\\/[A-Za-z0-9_.-]+$/', $githubRepo) ? $githubRepo : 'RovxBot/homelab-infra';
      $githubBranchSafe = preg_match('/^[A-Za-z0-9_.\\/-]+$/', $githubBranch) ? $githubBranch : 'main';
      $commitsPage = 'https://github.com/' . $githubRepoSafe . '/commits/' . rawurlencode($githubBranchSafe);

      $commits = [];
      try {
        ensureSession();
        $cacheKey = 'commits_cache';
        $cacheAtKey = 'commits_cache_at';
        $cacheTtl = 60; // seconds

        $now = time();
        if (!empty($_SESSION[$cacheKey]) && !empty($_SESSION[$cacheAtKey]) && ($now - (int)$_SESSION[$cacheAtKey]) < $cacheTtl) {
          $commits = (array)$_SESSION[$cacheKey];
        } else {
          $api = 'https://api.github.com/repos/' . $githubRepoSafe . '/commits?per_page=6&sha=' . rawurlencode($githubBranchSafe);
          $ctx = stream_context_create([
            'http' => [
              'method' => 'GET',
              'timeout' => 2,
              'header' => implode("\r\n", [
                'Accept: application/vnd.github+json',
                'User-Agent: grimguzzler-portal',
              ]),
            ],
          ]);
          $json = @file_get_contents($api, false, $ctx);
          if ($json !== false) {
            $data = json_decode($json, true, 512, JSON_THROW_ON_ERROR);
            if (is_array($data)) {
              foreach ($data as $c) {
                if (!is_array($c)) continue;
                $sha = (string)($c['sha'] ?? '');
                $htmlUrl = (string)($c['html_url'] ?? '');
                $msg = (string)($c['commit']['message'] ?? '');
                $date = (string)($c['commit']['committer']['date'] ?? '');
                if ($sha === '' || $htmlUrl === '' || $msg === '') continue;
                $firstLine = trim(explode("\n", $msg, 2)[0]);
                $commits[] = [
                  'sha' => substr($sha, 0, 7),
                  'url' => $htmlUrl,
                  'msg' => $firstLine,
                  'date' => $date,
                ];
              }
            }
          }
          $_SESSION[$cacheKey] = $commits;
          $_SESSION[$cacheAtKey] = $now;
        }
      } catch (Throwable $e) {
        $commits = [];
      }

      $commitsRows = '';
      foreach ($commits as $c) {
        $msg = htmlspecialchars((string)($c['msg'] ?? ''));
        $sha = htmlspecialchars((string)($c['sha'] ?? ''));
        $url = htmlspecialchars((string)($c['url'] ?? ''));
        $date = htmlspecialchars((string)($c['date'] ?? ''));
        if ($msg === '' || $sha === '' || $url === '') continue;
        $commitsRows .= '<tr><td><a href="' . $url . '" target="_blank" rel="noreferrer">' . $msg . '</a><div class="muted" style="margin-top:4px;"><span class="pill">' . $sha . '</span> <span class="pill">' . $date . '</span></div></td></tr>';
      }
      if ($commitsRows === '') {
        $commitsRows = '<tr><td class="muted">Unable to load recent commits right now. <a href="' . htmlspecialchars($commitsPage) . '" target="_blank" rel="noreferrer">View commit history</a>.</td></tr>';
      }

      $topKillsRows = '';
      foreach ($stats['top_kills'] as $r) {
        $name = htmlspecialchars((string)($r['name'] ?? ''));
        $class = (int)($r['class'] ?? 0);
        $level = (int)($r['level'] ?? 0);
        $gained = (int)($r['gained'] ?? 0);
        $topKillsRows .= '<tr><td>' . classPill($class) . $name . '</td><td><span class="pill">' . $level . '</span></td><td><span class="pill">' . $gained . '</span></td></tr>';
      }
      if ($topKillsRows === '') {
        $topKillsRows = '<tr><td colspan="3" class="muted">Not enough data yet (snapshot job needs to run).</td></tr>';
      }

      $topLevelsRows = '';
      foreach ($stats['top_levels'] as $r) {
        $name = htmlspecialchars((string)($r['name'] ?? ''));
        $class = (int)($r['class'] ?? 0);
        $level = (int)($r['level'] ?? 0);
        $gained = (int)($r['gained'] ?? 0);
        $topLevelsRows .= '<tr><td>' . classPill($class) . $name . '</td><td><span class="pill">' . $level . '</span></td><td><span class="pill">+' . $gained . '</span></td></tr>';
      }
      if ($topLevelsRows === '') {
        $topLevelsRows = '<tr><td colspan="3" class="muted">Not enough data yet (snapshot job needs to run).</td></tr>';
      }

      $signup = '';
      if (isSignupEnabled()) {
        $signup = <<<HTML
        <div class="panel">
          <div class="hd"><h2>Create Account (Invite)</h2></div>
          <div class="bd">
            <form method="post">
              <input type="hidden" name="csrf" value="{$csrf}" />
              <input type="hidden" name="action" value="signup" />
              <label>Username</label>
              <input name="username" autocomplete="username" required />
              <label>Password (max 16 chars)</label>
              <input name="password" type="password" autocomplete="new-password" required />
              <label>Email</label>
              <input name="email" type="email" autocomplete="email" required />
              <label>Invite code</label>
              <input name="invite" required />
              <div style="margin-top:12px;">
                <button class="btn" type="submit">Create account</button>
              </div>
            </form>
          </div>
        </div>
        HTML;
      }

      $body = <<<HTML
      <div class="grid">
        <div>
          <div class="panel">
            <div class="hd"><h2>Announcements</h2></div>
            <div class="bd">
              <div style="margin-top:2px;">{$annLeadHtml}</div>
              <div style="margin-top:12px;">{$announcementsHtml}</div>
              <div class="muted" style="margin-top:12px;">Recent updates</div>
              <table class="table" style="margin-top:6px;">
                <tbody>{$commitsRows}</tbody>
              </table>
              <div class="muted" style="margin-top:10px;"><a href="{$commitsPage}" target="_blank" rel="noreferrer">View all commits</a></div>
            </div>
          </div>
          <div class="panel" style="margin-top:14px;">
            <div class="hd"><h2>Weekly Stats</h2></div>
            <div class="bd">
              <div class="muted" style="margin-bottom: 10px;">Last 7 days (best effort).</div>
              <div class="row" style="align-items:flex-start;">
                <div>
                  <div class="muted" style="margin-bottom: 6px;">Top PvP kills</div>
                  <table class="table">
                    <thead><tr><th>Character</th><th>Lvl</th><th>+Kills</th></tr></thead>
                    <tbody>{$topKillsRows}</tbody>
                  </table>
                </div>
                <div>
                  <div class="muted" style="margin-bottom: 6px;">Top levels gained</div>
                  <table class="table">
                    <thead><tr><th>Character</th><th>Lvl</th><th>+Levels</th></tr></thead>
                    <tbody>{$topLevelsRows}</tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div>
          <div class="panel">
            <div class="hd"><h2>Sign In</h2></div>
            <div class="bd">
              <div class="kpi">
                <div class="card">
                  <div class="muted">Players online</div>
                  <div class="val">{$online}</div>
                </div>
              </div>
              <form method="post" style="margin-top:14px;">
                <input type="hidden" name="csrf" value="{$csrf}" />
                <input type="hidden" name="action" value="login" />
                <label>Account name</label>
                <input name="login_user" autocomplete="username" required />
                <label>Password</label>
                <input name="login_pass" type="password" autocomplete="current-password" required />
                <div style="margin-top:12px;">
                  <button class="btn" type="submit">{$iconLogin}Log In</button>
                </div>
              </form>
            </div>
          </div>
          <div class="panel" style="margin-top:14px;">
            <div class="hd"><h2>Realm Status</h2></div>
            <div class="bd">
              <div><strong>{$realmName}</strong></div>
              <div class="muted" style="margin-top:6px;">Connect: <span class="pill">{$realmAddr}:{$realmPort}</span></div>
              <div class="muted" style="margin-top:10px;">Snapshot: <span class="pill">{$snapshotDate}</span> (<span class="pill">{$snapshotRows}</span> rows)</div>
            </div>
          </div>
          {$signup}
        </div>
      </div>
      HTML;

      render($body, $flash, $flashKind);
    }

    function renderAboutPage(array $realm, string $flash = '', string $flashKind = 'info'): void {
      $realmName = htmlspecialchars((string)($realm['name'] ?? 'Unknown'));
      $realmAddr = htmlspecialchars((string)($realm['address'] ?? ''));
      $realmPort = (int)($realm['port'] ?? 0);

      $body = <<<HTML
      <div class="panel">
        <div class="hd"><h2>About Grim Guzzler</h2></div>
        <div class="bd">
          <div class="row" style="align-items:flex-start;">
            <div style="flex: 1;">
              <div class="muted" style="margin-bottom:8px;">Server info</div>
              <ul class="muted" style="margin:0; padding-left: 18px; line-height: 1.7;">
                <li><strong>Expansion:</strong> Wrath of the Lich King (3.3.5a)</li>
                <li><strong>Rates:</strong> Blizzlike (XP/Loot/Gold/Rep/Honor = x1)</li>
                <li><strong>Bots:</strong> Playerbots enabled (party-friendly world population)</li>
                <li><strong>Progression:</strong> Is gated so all content must be cleared before moving onto the next phase. This is done per character.</li>
                <li><strong>Shop/Donations:</strong> No pay to win, or donation mechanics. Play the game as it was meant to be played.</li>
              </ul>
              <div class="muted" style="margin-top:12px;">
                Realm: <strong>{$realmName}</strong> — <span class="pill">{$realmAddr}:{$realmPort}</span>
              </div>
            </div>
            <div style="flex: 1;">
              <div class="muted" style="margin-bottom:8px;">Project</div>
              <div class="row" style="gap: 12px; align-items:center;">
                <img src="https://www.azerothcore.org/images/logo.png" alt="AzerothCore logo" style="width: 150px; height:auto; filter: drop-shadow(0 8px 16px rgba(0,0,0,.35));" />
                <div class="muted">
                  Built on <a href="https://www.azerothcore.org/" target="_blank" rel="noreferrer">AzerothCore</a> and deployed on Kubernetes.
                  <div style="margin-top:6px;">This server was set up and deployed as a learning project. It is in no way a production or commercial server.</div>
                  <div style="margin-top:6px;">This project is not affiliated with or endorsed by Blizzard Entertainment. All trademarks and copyrights belong to their respective owners.</div>
                  <div style="margin-top:6px;">I will continue to improve and maintaine this server for as long as it remains utilised, or until I am asked to stop by the rightful owners.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted" style="margin-bottom:8px;">How to connect</div>
          <ol class="muted" style="margin:0; padding-left: 18px; line-height: 1.7;">
            <li>Ask an admin for an <strong>invite</strong> (account creation is invite-only).</li>
            <li>Download a 3.3.5a client: <a href="https://www.chromiecraft.com/en/downloads/" target="_blank" rel="noreferrer">ChromieCraft Downloads</a></li>
            <li>Set realmlist to: <span class="pill">grim.cooked.beer</span></li>
          </ol>
        </div>
      </div>
      HTML;

      render($body, $flash, $flashKind);
    }

    function renderServerInfoPage(array $realm, string $flash = '', string $flashKind = 'info'): void {
      $realmName = htmlspecialchars((string)($realm['name'] ?? 'Unknown'));
      $realmAddr = htmlspecialchars((string)($realm['address'] ?? ''));
      $realmPort = (int)($realm['port'] ?? 0);
      $patchNote = '<a href="/?download=patch-s">patch-S.mpq</a>';

      $body = <<<HTML
      <div class="panel">
        <div class="hd"><h2>Server Information</h2></div>
        <div class="bd">
          <div class="row" style="align-items:flex-start;">
            <div style="flex:1;">
              <div class="muted" style="margin-bottom:8px;">Realm status</div>
              <div><strong>{$realmName}</strong></div>
              <div class="muted" style="margin-top:6px;">Connect: <span class="pill">{$realmAddr}:{$realmPort}</span></div>
              <div class="muted" style="margin-top:12px;">Expansion: Wrath of the Lich King (3.3.5a)</div>
              <div class="muted" style="margin-top:6px;">Rates: Blizzlike (x1)</div>
              <div class="muted" style="margin-top:6px;">Progression: Individual per character, content gated by raid clears.</div>
              <div class="muted" style="margin-top:6px;">Bots: Playerbots enabled to keep the world alive.</div>
            </div>
            <div style="flex:1;">
              <div class="muted" style="margin-bottom:8px;">Rules & notes</div>
              <ul class="muted" style="margin:0; padding-left: 18px; line-height: 1.7;">
                <li>Invite-only accounts. Ask an admin for access.</li>
                <li>No pay-to-win or donations.</li>
                <li>Use common sense and respect other players.</li>
                <li>Raid/instance progress is tracked per character.</li>
              </ul>
              <div class="muted" style="margin-top:12px;">Optional progression patch: {$patchNote}</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="muted" style="margin-bottom:8px;">How to connect</div>
          <ol class="muted" style="margin:0; padding-left: 18px; line-height: 1.7;">
            <li>Install a 3.3.5a client from <a href="https://www.chromiecraft.com/en/downloads/" target="_blank" rel="noreferrer">ChromieCraft Downloads</a>.</li>
            <li>Set realmlist to: <span class="pill">grim.cooked.beer</span></li>
            <li>Apply the optional patch if you want classic reagent behavior.</li>
          </ol>
        </div>
      </div>
      HTML;

      render($body, $flash, $flashKind);
    }

    function renderForumPage(PDO $pdo, bool $allowPosting, string $flash = '', string $flashKind = 'info'): void {
      $csrf = htmlspecialchars(csrfToken());
      $categoryId = (int)($_GET['f'] ?? 0);
      $threadId = (int)($_GET['t'] ?? 0);
      $query = trim((string)($_GET['q'] ?? ''));
      $queryEsc = htmlspecialchars($query);
      $isAdminUser = $allowPosting && isAdmin($pdo, currentAccountId());
      $adminIds = $allowPosting ? adminAccountIds($pdo) : [];

      $breadcrumb = '<a href="/?tab=forum">Forum Home</a>';
      $body = '';

      if ($threadId > 0) {
        $thread = getForumThread($pdo, $threadId);
        $category = getForumCategory($pdo, (int)$thread['category_id']);
        $page = max(1, (int)($_GET['p'] ?? 1));
        $limit = 15;
        $offset = ($page - 1) * $limit;
        $totalPosts = countForumPosts($pdo, $threadId);
        $posts = listForumPostsPage($pdo, $threadId, $limit, $offset);
        $locked = (int)$thread['is_locked'] === 1;
        $breadcrumb .= ' / <a href="/?tab=forum&f=' . (int)$category['id'] . '">' . htmlspecialchars((string)$category['name']) . '</a>';
        $breadcrumb .= ' / ' . htmlspecialchars((string)$thread['title']);

        $postsHtml = '';
        foreach ($posts as $p) {
          $author = htmlspecialchars((string)$p['author']);
          $bodyHtml = nl2br(htmlspecialchars((string)$p['body']));
          $created = htmlspecialchars((string)$p['created_at']);
          $isAdminPost = $allowPosting && isset($adminIds[(int)$p['author_account_id']]);
          $badge = $isAdminPost ? ' <span class="badge admin">Blizzard Rep</span>' : '';
          $postClass = $isAdminPost ? 'post admin' : 'post';
          $initial = $author !== '' ? strtoupper($author[0]) : '?';
          $avatar = '<div class="avatar">' . htmlspecialchars($initial) . '</div>';

          $modControls = '';
          if ($isAdminUser) {
            $modControls = '<form method="post" style="margin-top:8px;">' .
              '<input type="hidden" name="csrf" value="' . $csrf . '" />' .
              '<input type="hidden" name="action" value="forum_delete_post" />' .
              '<input type="hidden" name="post_id" value="' . (int)$p['id'] . '" />' .
              '<input type="hidden" name="t" value="' . $threadId . '" />' .
              '<button class="btn danger" type="submit">Remove Post</button>' .
              '</form>';
          }

          $postsHtml .= '<div class="' . $postClass . '">' .
            '<div class="post-row">' . $avatar .
            '<div class="post-content">' .
              '<div class="post-title">' . $author . $badge . '</div>' .
              '<div class="post-meta">' . $created . '</div>' .
              '<div class="post-body">' . $bodyHtml . '</div>' .
              $modControls .
            '</div></div>' .
            '</div>';
        }
        if ($postsHtml === '') {
          $postsHtml = '<div class="muted">No posts yet.</div>';
        }

        $pagination = '';
        if ($totalPosts > $limit) {
          $pages = (int)ceil($totalPosts / $limit);
          $pagination = '<div class="muted" style="margin-top:12px;">Pages: ';
          for ($i = 1; $i <= $pages; $i++) {
            $active = $i === $page ? '<span class="pill">' . $i . '</span>' : '<a class="pill" href="/?tab=forum&t=' . $threadId . '&p=' . $i . '">' . $i . '</a>';
            $pagination .= $active . ' ';
          }
          $pagination .= '</div>';
        }

        $replyForm = '';
        if ($allowPosting && !$locked) {
          $replyForm = <<<HTML
            <div class="panel" style="margin-top:14px;">
              <div class="hd"><h2>Reply</h2></div>
              <div class="bd">
                <form method="post">
                  <input type="hidden" name="csrf" value="{$csrf}" />
                  <input type="hidden" name="action" value="forum_reply" />
                  <input type="hidden" name="thread_id" value="{$threadId}" />
                  <label>Message</label>
                  <textarea name="body" required></textarea>
                  <div style="margin-top:12px;">
                    <button class="btn" type="submit">Post reply</button>
                  </div>
                </form>
              </div>
            </div>
          HTML;
        } elseif ($locked) {
          $replyForm = '<div class="muted" style="margin-top:12px;">This thread is locked.</div>';
        } else {
          $replyForm = '<div class="muted" style="margin-top:12px;">Log in to reply.</div>';
        }

        $modButtons = '';
        if ($isAdminUser) {
          $lockAction = $locked ? 'forum_unlock_thread' : 'forum_lock_thread';
          $lockLabel = $locked ? 'Unlock' : 'Lock';
          $pinAction = ((int)$thread['is_pinned'] === 1) ? 'forum_unpin_thread' : 'forum_pin_thread';
          $pinLabel = ((int)$thread['is_pinned'] === 1) ? 'Unpin' : 'Pin';
          $modButtons = '<form method="post" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">' .
            '<input type="hidden" name="csrf" value="' . $csrf . '" />' .
            '<input type="hidden" name="thread_id" value="' . $threadId . '" />' .
            '<input type="hidden" name="f" value="' . (int)$category['id'] . '" />' .
            '<button class="btn secondary" type="submit" name="action" value="' . $pinAction . '">' . $pinLabel . '</button>' .
            '<button class="btn secondary" type="submit" name="action" value="' . $lockAction . '">' . $lockLabel . '</button>' .
            '<button class="btn danger" type="submit" name="action" value="forum_delete_thread">Remove Thread</button>' .
            '</form>';
        }

        $body = <<<HTML
        <div class="panel">
          <div class="hd"><h2>Forum Thread</h2></div>
          <div class="bd">
            <div class="muted">{$breadcrumb}</div>
            {$modButtons}
            <div style="margin-top:14px;">{$postsHtml}</div>
            {$pagination}
            {$replyForm}
          </div>
        </div>
        HTML;
      } elseif ($categoryId > 0) {
        $category = getForumCategory($pdo, $categoryId);
        $page = max(1, (int)($_GET['page'] ?? 1));
        $limit = 20;
        $offset = ($page - 1) * $limit;
        $totalThreads = countForumThreads($pdo, $categoryId, $query);
        $threads = listForumThreadsPage($pdo, $categoryId, $limit, $offset, $query);
        $breadcrumb .= ' / ' . htmlspecialchars((string)$category['name']);

        $rows = '';
        foreach ($threads as $t) {
          $title = htmlspecialchars((string)$t['title']);
          $author = htmlspecialchars((string)$t['author']);
          $updated = htmlspecialchars((string)($t['last_post_at'] ?? $t['updated_at']));
          $replies = (int)$t['replies'];
          $locked = (int)$t['is_locked'] === 1 ? ' • Locked' : '';
          $pinned = (int)$t['is_pinned'] === 1 ? ' • Pinned' : '';
          $lastAuthor = htmlspecialchars((string)($t['last_author'] ?? $t['author']));
          $rows .= '<div class="forum-item">' .
            '<div class="forum-row">' .
              '<div class="forum-cell">' .
                '<div class="forum-title"><a href="/?tab=forum&t=' . (int)$t['id'] . '">' . $title . '</a></div>' .
                '<div class="forum-meta">By ' . $author . $pinned . $locked . '</div>' .
              '</div>' .
              '<div class="forum-cell right"><span class="pill">' . $replies . '</span><div class="forum-meta">Replies</div></div>' .
              '<div class="forum-cell right"><span class="pill">' . $updated . '</span><div class="forum-meta">Last post: ' . $lastAuthor . '</div></div>' .
            '</div>' .
            '</div>';
        }
        if ($rows === '') {
          $rows = '<div class="muted">No threads yet. Be the first to post.</div>';
        }

        $searchForm = <<<HTML
          <form method="get" style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input type="hidden" name="tab" value="forum" />
            <input type="hidden" name="f" value="{$categoryId}" />
            <label style="margin:0;">Search</label>
            <input name="q" value="{$queryEsc}" placeholder="Search threads..." />
            <button class="btn secondary" type="submit">Search</button>
          </form>
        HTML;

        $pagination = '';
        if ($totalThreads > $limit) {
          $pages = (int)ceil($totalThreads / $limit);
          $pagination = '<div class="muted" style="margin-top:12px;">Pages: ';
          for ($i = 1; $i <= $pages; $i++) {
            $active = $i === $page ? '<span class="pill">' . $i . '</span>' : '<a class="pill" href="/?tab=forum&f=' . $categoryId . '&page=' . $i . '&q=' . urlencode($query) . '">' . $i . '</a>';
            $pagination .= $active . ' ';
          }
          $pagination .= '</div>';
        }

        $newThread = '';
        if ($allowPosting && (int)$category['is_locked'] === 0) {
          $newThread = <<<HTML
            <div class="panel" style="margin-top:14px;">
              <div class="hd"><h2>New Thread</h2></div>
              <div class="bd">
                <form method="post">
                  <input type="hidden" name="csrf" value="{$csrf}" />
                  <input type="hidden" name="action" value="forum_create_thread" />
                  <input type="hidden" name="category_id" value="{$categoryId}" />
                  <label>Title</label>
                  <input name="title" required />
                  <label>Message</label>
                  <textarea name="body" required></textarea>
                  <div style="margin-top:12px;">
                    <button class="btn" type="submit">Post thread</button>
                  </div>
                </form>
              </div>
            </div>
          HTML;
        } elseif ((int)$category['is_locked'] === 1) {
          $newThread = '<div class="muted" style="margin-top:12px;">This category is locked.</div>';
        } else {
          $newThread = '<div class="muted" style="margin-top:12px;">Log in to start a thread.</div>';
        }

        $body = <<<HTML
        <div class="panel">
          <div class="hd"><h2>Forum: {$category['name']}</h2></div>
          <div class="bd">
            <div class="muted">{$breadcrumb}</div>
            {$searchForm}
            <div class="forum-grid" style="margin-top:12px;">{$rows}</div>
            {$pagination}
            {$newThread}
          </div>
        </div>
        HTML;
      } else {
        $cats = listForumCategories($pdo);
        $items = '';
        foreach ($cats as $c) {
          $name = htmlspecialchars((string)$c['name']);
          $desc = htmlspecialchars((string)$c['description']);
          $threads = (int)$c['threads'];
          $posts = (int)$c['posts'];
          $items .= '<div class="forum-item">' .
            '<div class="forum-title"><a href="/?tab=forum&f=' . (int)$c['id'] . '">' . $name . '</a></div>' .
            '<div class="muted">' . $desc . '</div>' .
            '<div class="forum-meta">Threads ' . $threads . ' • Posts ' . $posts . '</div>' .
            '</div>';
        }
        if ($items === '') {
          $items = '<div class="muted">Forum categories are not available yet.</div>';
        }

        $rules = '<div class="forum-item"><div class="forum-title">Realm Rules</div>' .
          '<div class="muted">Be respectful. No exploits. Keep it friendly. Admin posts are highlighted in blue.</div></div>';

        $searchResults = '';
        $searchForm = <<<HTML
          <form method="get" style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input type="hidden" name="tab" value="forum" />
            <label style="margin:0;">Search</label>
            <input name="q" value="{$queryEsc}" placeholder="Search all threads..." />
            <button class="btn secondary" type="submit">Search</button>
          </form>
        HTML;
        if ($query !== '') {
          $page = max(1, (int)($_GET['page'] ?? 1));
          $limit = 15;
          $offset = ($page - 1) * $limit;
          $total = countForumSearchAll($pdo, $query);
          $results = listForumSearchAll($pdo, $query, $limit, $offset);
          $rows = '';
          foreach ($results as $t) {
            $title = htmlspecialchars((string)$t['title']);
            $author = htmlspecialchars((string)$t['author']);
            $updated = htmlspecialchars((string)($t['last_post_at'] ?? $t['updated_at']));
            $replies = (int)$t['replies'];
            $rows .= '<div class="forum-item">' .
              '<div class="forum-row">' .
                '<div class="forum-cell">' .
                  '<div class="forum-title"><a href="/?tab=forum&t=' . (int)$t['id'] . '">' . $title . '</a></div>' .
                  '<div class="forum-meta">By ' . $author . '</div>' .
                '</div>' .
                '<div class="forum-cell right"><span class="pill">' . $replies . '</span><div class="forum-meta">Replies</div></div>' .
                '<div class="forum-cell right"><span class="pill">' . $updated . '</span><div class="forum-meta">Updated</div></div>' .
              '</div>' .
              '</div>';
          }
          if ($rows === '') {
            $rows = '<div class="muted">No results found.</div>';
          }
          $pagination = '';
          if ($total > $limit) {
            $pages = (int)ceil($total / $limit);
            $pagination = '<div class="muted" style="margin-top:12px;">Pages: ';
            for ($i = 1; $i <= $pages; $i++) {
              $active = $i === $page ? '<span class="pill">' . $i . '</span>' : '<a class="pill" href="/?tab=forum&page=' . $i . '&q=' . urlencode($query) . '">' . $i . '</a>';
              $pagination .= $active . ' ';
            }
            $pagination .= '</div>';
          }
          $searchResults = '<div class="divider"></div><div class="muted">Search results</div><div class="forum-grid" style="margin-top:12px;">' . $rows . '</div>' . $pagination;
        }

        $body = <<<HTML
        <div class="panel">
          <div class="hd"><h2>Forum Index</h2></div>
          <div class="bd">
            <div class="muted">{$breadcrumb}</div>
            {$searchForm}
            <div class="forum-grid" style="margin-top:12px;">
              {$rules}
              {$items}
            </div>
            {$searchResults}
          </div>
        </div>
        HTML;
      }

      render($body, $flash, $flashKind);
    }

    function renderPortal(PDO $pdo, array $stats, array $realm, array $snap, array $chars, array $announcements, string $flash = '', string $flashKind = 'info'): void {
      $csrf = htmlspecialchars(csrfToken());
      $online = (int)$stats['players_online'];
      $tab = (string)($_GET['tab'] ?? 'overview');
      if (!in_array($tab, ['overview', 'announcements', 'server', 'characters', 'services', 'store', 'stats', 'arena', 'about'], true)) {
        $tab = 'overview';
      }

      $iconLogout = '<svg viewBox="0 0 24 24" fill="none"><path d="M10 7V5a2 2 0 0 1 2-2h7v18h-7a2 2 0 0 1-2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M3 12h10m0 0-3-3m3 3-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      $iconKey = '<svg viewBox="0 0 24 24" fill="none"><path d="M7.5 14.5a5.5 5.5 0 1 1 4.9-8H22v4h-2v2h-2v2h-2.6A5.5 5.5 0 0 1 7.5 14.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M7.5 10.5h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>';
      $iconQuill = '<svg viewBox="0 0 24 24" fill="none"><path d="M20 4c-7 2-12 7-14 14l-2 2 4-1c7-2 12-7 14-14-1-1-1-1-2-1Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M9 15l-1 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
      $iconMask = '<svg viewBox="0 0 24 24" fill="none"><path d="M4 7c4-3 12-3 16 0v6c0 4-4 8-8 8s-8-4-8-8V7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M8 12h.01M16 12h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>';
      $iconGrave = '<svg viewBox="0 0 24 24" fill="none"><path d="M7 21V9a5 5 0 0 1 10 0v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M10 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';

      $realmName = htmlspecialchars((string)($realm['name'] ?? 'Unknown'));
      $realmAddr = htmlspecialchars((string)($realm['address'] ?? ''));
      $realmPort = (int)($realm['port'] ?? 0);
      $snapshotDate = htmlspecialchars((string)($snap['date'] ?? ''));
      $snapshotRows = (int)($snap['rows'] ?? 0);

      $rows = '';
      foreach ($chars as $c) {
        $guid = (int)$c['guid'];
        $name = htmlspecialchars((string)$c['name']);
        $level = (int)$c['level'];
        $isOnline = (int)$c['online'] === 1;
        $state = $isOnline ? '<span class="pill">Online</span>' : '<span class="pill">Offline</span>';
        $disabled = $isOnline ? 'disabled' : '';

        $rows .= <<<HTML
        <tr>
          <td><strong>{$name}</strong><div class="muted">GUID {$guid}</div></td>
          <td>{$level}</td>
          <td>{$state}</td>
          <td>
            <form method="post" style="display:flex;gap:8px;flex-wrap:wrap;">
              <input type="hidden" name="csrf" value="{$csrf}" />
              <input type="hidden" name="guid" value="{$guid}" />
              <button class="btn secondary" type="submit" name="action" value="rename" {$disabled}>{$iconQuill}Rename</button>
              <button class="btn secondary" type="submit" name="action" value="race_change" {$disabled}>{$iconMask}Race Change</button>
              <button class="btn danger" type="submit" name="action" value="unstuck" {$disabled}>{$iconGrave}Unstuck</button>
            </form>
          </td>
        </tr>
        HTML;
      }
      if ($rows === '') {
        $rows = '<tr><td colspan="4" class="muted">No characters found.</td></tr>';
      }

      $mainTitle = 'My Account';
      $mainBody = '';

      if ($tab === 'overview') {
        $mainTitle = 'My Account';
        $profile = getAccountProfile($pdo, currentAccountId());
        $pName = htmlspecialchars((string)$profile['top_name']);
        $pClass = (int)$profile['top_class'];
        $pLevel = (int)$profile['top_level'];
        $pTotal = (int)$profile['total_chars'];
        $pSummary = $pName !== '' ? (classPill($pClass) . $pName . ' <span class="pill">Lvl ' . $pLevel . '</span>') : '<span class="muted">No characters yet.</span>';
        $mainBody = <<<HTML
          <div class="kpi">
            <div class="card"><div class="muted">Players online</div><div class="val">{$online}</div></div>
            <div class="card"><div class="muted">Characters</div><div class="val">{$pTotal}</div></div>
          </div>
          <div class="panel" style="margin-top:14px;">
            <div class="hd"><h2>Profile Snapshot</h2></div>
            <div class="bd">
              <div class="muted">Highest level character</div>
              <div style="margin-top:8px;">{$pSummary}</div>
            </div>
          </div>
          <div style="margin-top:12px; display:flex; justify-content:flex-end;">
            <form method="post">
              <input type="hidden" name="csrf" value="{$csrf}" />
              <button class="btn secondary" type="submit" name="action" value="logout">{$iconLogout}Log Out</button>
            </form>
          </div>
        HTML;
      } elseif ($tab === 'announcements') {
        $mainTitle = 'Announcements';
        $isAdmin = isAdmin($pdo, currentAccountId());
        $listHtml = renderAnnouncementsList($announcements, 'No announcements yet.');
        $adminPanel = '';
        if ($isAdmin) {
          $adminPanel = <<<HTML
            <div class="panel" style="margin-top:14px;">
              <div class="hd"><h2>Post Update</h2></div>
              <div class="bd">
                <form method="post">
                  <input type="hidden" name="csrf" value="{$csrf}" />
                  <input type="hidden" name="action" value="announce_create" />
                  <label>Title</label>
                  <input name="announce_title" required />
                  <label>Body</label>
                  <textarea name="announce_body" required></textarea>
                  <div style="margin-top:12px;">
                    <button class="btn" type="submit">Post announcement</button>
                  </div>
                </form>
              </div>
            </div>
          HTML;
        }

        $deleteRows = '';
        if ($isAdmin && $announcements) {
          foreach ($announcements as $a) {
            $id = (int)($a['id'] ?? 0);
            $title = htmlspecialchars((string)($a['title'] ?? ''));
            $deleteRows .= '<tr><td>' . $title . '</td><td style="text-align:right;">' .
              '<form method="post" style="margin:0;">' .
              '<input type="hidden" name="csrf" value="' . $csrf . '" />' .
              '<input type="hidden" name="action" value="announce_delete" />' .
              '<input type="hidden" name="announce_id" value="' . $id . '" />' .
              '<button class="btn danger" type="submit">Delete</button>' .
              '</form></td></tr>';
          }
        }

        $deletePanel = '';
        if ($deleteRows !== '') {
          $deletePanel = <<<HTML
            <div class="panel" style="margin-top:14px;">
              <div class="hd"><h2>Manage Posts</h2></div>
              <div class="bd">
                <table class="table">
                  <thead><tr><th>Announcement</th><th></th></tr></thead>
                  <tbody>{$deleteRows}</tbody>
                </table>
              </div>
            </div>
          HTML;
        }

        $mainBody = <<<HTML
          {$listHtml}
          {$adminPanel}
          {$deletePanel}
        HTML;
      } elseif ($tab === 'characters') {
        $mainTitle = 'Characters';
        $mainBody = <<<HTML
          <table class="table">
            <thead><tr><th>Character</th><th>Level</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>{$rows}</tbody>
          </table>
        HTML;
      } elseif ($tab === 'services') {
        $mainTitle = 'Services';
        $mainBody = <<<HTML
          <div class="muted">Character services are applied on next login (and require the character to be offline).</div>
          <div style="margin-top:12px;">
            <div class="pill">Rename</div>
            <div class="pill">Race Change</div>
            <div class="pill">Unstuck to Graveyard</div>
          </div>
          <div class="muted" style="margin-top:12px;">Go to the Characters tab and use the buttons next to a character.</div>
        HTML;
      } elseif ($tab === 'store') {
        $mainTitle = 'Store';

        $selectedGuid = (int)($_GET['guid'] ?? 0);
        if ($selectedGuid <= 0 && !empty($chars[0]['guid'])) {
          $selectedGuid = (int)$chars[0]['guid'];
        }

        $selected = null;
        foreach ($chars as $c) {
          if ((int)$c['guid'] === $selectedGuid) {
            $selected = $c;
            break;
          }
        }

        $selector = '<div class="muted">Select a character to view token balance.</div>';
        $balance = 0;
        $disabledNote = '';
        if ($selected) {
          $charNameRaw = (string)$selected['name'];
          $isOnline = (int)$selected['online'] === 1;
          $isBot = isBotCharacter($pdo, $charNameRaw);
          $balance = tokenCount($pdo, (int)$selected['guid']);

          $selector = '<form method="get" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">' .
            '<input type="hidden" name="tab" value="store" />' .
            '<label style="margin:0;">Character</label>' .
            '<select name="guid" onchange="this.form.submit()">';
          foreach ($chars as $c) {
            $g = (int)$c['guid'];
            $n = htmlspecialchars((string)$c['name']);
            $sel = $g === (int)$selected['guid'] ? ' selected' : '';
            $selector .= '<option value="' . $g . '"' . $sel . '>' . $n . '</option>';
          }
          $selector .= '</select></form>';

          if ($isBot) {
            $disabledNote = '<div class="flash warn" style="margin-top:10px;">Bot characters cannot use the store.</div>';
          } elseif ($isOnline) {
            $disabledNote = '<div class="flash warn" style="margin-top:10px;">Character must be offline to purchase.</div>';
          }
        }

        $itemsRows = '';
        foreach (storeItems() as $it) {
          $id = (int)$it['id'];
          $name = htmlspecialchars((string)$it['name']);
          $cost = (int)$it['cost'];
          $note = htmlspecialchars((string)($it['note'] ?? ''));

          $canBuy = $selected && $disabledNote === '' && $balance >= $cost;
          $btnDisabled = $canBuy ? '' : 'disabled';

          $itemsRows .= '<tr><td><strong>' . $name . '</strong><div class="muted">Item ' . $id . '</div><div class="muted">' . $note . '</div></td><td><span class="pill">' . $cost . '</span></td><td>' .
            '<form method="post" style="margin:0;display:flex;gap:8px;justify-content:flex-end;align-items:center;">' .
            '<input type="hidden" name="csrf" value="' . $csrf . '" />' .
            '<input type="hidden" name="action" value="store_purchase" />' .
            '<input type="hidden" name="guid" value="' . (int)($selected['guid'] ?? 0) . '" />' .
            '<input type="hidden" name="item_id" value="' . $id . '" />' .
            '<button class="btn" type="submit" ' . $btnDisabled . '>Buy</button>' .
            '</form></td></tr>';
        }

        $mainBody = <<<HTML
          {$selector}
          <div class="kpi" style="margin-top:12px;">
            <div class="card"><div class="muted">Grim Tokens</div><div class="val">{$balance}</div></div>
          </div>
          {$disabledNote}
          <div class="muted" style="margin-top:14px;">Purchases are delivered via in-game mail.</div>
          <table class="table" style="margin-top:10px;">
            <thead><tr><th>Item</th><th>Cost</th><th></th></tr></thead>
            <tbody>{$itemsRows}</tbody>
          </table>
        HTML;
      } elseif ($tab === 'arena') {
        $charDb = dbName('DB_CHAR_DB', 'acore_characters');

        $teamStmt = $pdo->prepare(
          "SELECT t.name AS team, t.type, t.rating, t.weekGames, t.weekWins, t.seasonGames, t.seasonWins, " .
          "c.name AS captain, c.class AS captainClass, c.level AS captainLevel " .
          "FROM {$charDb}.arena_team t " .
          "LEFT JOIN {$charDb}.characters c ON c.guid = t.captainGuid " .
          "WHERE t.type = :type " .
          "ORDER BY t.rating DESC, t.rank ASC, t.arenaTeamId ASC " .
          "LIMIT 10"
        );

        $brackets = [
          2 => '2v2',
          3 => '3v3',
          5 => '5v5',
        ];

        $sections = '';
        foreach ($brackets as $type => $label) {
          $teamStmt->execute([':type' => $type]);
          $teams = $teamStmt->fetchAll();
          $rows = '';
          foreach ($teams as $t) {
            $team = htmlspecialchars((string)($t['team'] ?? ''));
            $rating = (int)($t['rating'] ?? 0);
            $wg = (int)($t['weekGames'] ?? 0);
            $ww = (int)($t['weekWins'] ?? 0);
            $sg = (int)($t['seasonGames'] ?? 0);
            $sw = (int)($t['seasonWins'] ?? 0);
            $capt = htmlspecialchars((string)($t['captain'] ?? ''));
            $cClass = (int)($t['captainClass'] ?? 0);
            $cLevel = (int)($t['captainLevel'] ?? 0);
            $captCell = $capt !== '' ? (classPill($cClass) . $capt . ' <span class="pill">' . $cLevel . '</span>') : '<span class="muted">—</span>';
            $rows .= '<tr><td><strong>' . $team . '</strong></td><td><span class="pill">' . $rating . '</span></td><td>' . $captCell . '</td><td><span class="pill">' . $ww . '/' . $wg . '</span></td><td><span class="pill">' . $sw . '/' . $sg . '</span></td></tr>';
          }
          if ($rows === '') {
            $rows = '<tr><td colspan="5" class="muted">No teams found for this bracket.</td></tr>';
          }
          $sections .= '<div class="panel" style="margin-top:14px;"><div class="hd"><h2>Arena Ladder ' . htmlspecialchars($label) . '</h2></div><div class="bd"><table class="table"><thead><tr><th>Team</th><th>Rating</th><th>Captain</th><th>Week</th><th>Season</th></tr></thead><tbody>' . $rows . '</tbody></table></div></div>';
        }

        $mainTitle = 'Arena';
        $mainBody = '<div class="muted">Current arena ladder snapshot from the characters database.</div>' . $sections;
      } elseif ($tab === 'about') {
        $mainTitle = 'About';
        $mainBody = <<<HTML
          <div class="muted">Realm: <strong>{$realmName}</strong> — <span class="pill">{$realmAddr}:{$realmPort}</span></div>
          <div class="divider"></div>
          <div class="row" style="align-items:flex-start;">
            <div>
              <div class="muted" style="margin-bottom:8px;">Server</div>
              <ul class="muted" style="margin:0; padding-left: 18px; line-height: 1.7;">
                <li><strong>Expansion:</strong> Wrath of the Lich King (3.3.5a)</li>
                <li><strong>Rates:</strong> Blizzlike (x1)</li>
                <li><strong>Bots:</strong> Playerbots enabled</li>
              </ul>
            </div>
            <div>
              <div class="muted" style="margin-bottom:8px;">Project</div>
              <div class="row" style="gap: 12px; align-items:center;">
                <img src="https://www.azerothcore.org/images/logo.png" alt="AzerothCore logo" style="width: 140px; height:auto; filter: drop-shadow(0 8px 16px rgba(0,0,0,.35));" />
                <div class="muted">
                  Powered by <a href="https://www.azerothcore.org/" target="_blank" rel="noreferrer">AzerothCore</a> and running on Kubernetes.
                </div>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="muted" style="margin-bottom:8px;">Connect</div>
          <ol class="muted" style="margin:0; padding-left: 18px; line-height: 1.7;">
            <li>Invite required (ask an admin).</li>
            <li>Client download: <a href="https://www.chromiecraft.com/en/downloads/" target="_blank" rel="noreferrer">ChromieCraft Downloads</a></li>
            <li>Set realmlist: <span class="pill">grim.cooked.beer</span></li>
            <li>Optional progression patch (WotLK mana costs): <a href="/?download=patch-s">patch-S.mpq</a></li>
          </ol>
        HTML;
      } else {
        $mainTitle = 'Stats';
        $topKills = '';
        foreach ($stats['top_kills'] as $r) {
          $name = htmlspecialchars((string)($r['name'] ?? ''));
          $class = (int)($r['class'] ?? 0);
          $level = (int)($r['level'] ?? 0);
          $gained = (int)($r['gained'] ?? 0);
          $topKills .= '<tr><td>' . classPill($class) . $name . '</td><td><span class="pill">' . $level . '</span></td><td><span class="pill">' . $gained . '</span></td></tr>';
        }
        if ($topKills === '') {
          $topKills = '<tr><td colspan="3" class="muted">Not enough data yet.</td></tr>';
        }
        $topLv = '';
        foreach ($stats['top_levels'] as $r) {
          $name = htmlspecialchars((string)($r['name'] ?? ''));
          $class = (int)($r['class'] ?? 0);
          $level = (int)($r['level'] ?? 0);
          $gained = (int)($r['gained'] ?? 0);
          $topLv .= '<tr><td>' . classPill($class) . $name . '</td><td><span class="pill">' . $level . '</span></td><td><span class="pill">+' . $gained . '</span></td></tr>';
        }
        if ($topLv === '') {
          $topLv = '<tr><td colspan="3" class="muted">Not enough data yet.</td></tr>';
        }
        $mainBody = <<<HTML
          <div class="muted">Last 7 days (based on daily snapshots).</div>
          <div class="row" style="align-items:flex-start;margin-top:10px;">
            <div>
              <div class="muted" style="margin-bottom: 6px;">Top PvP kills</div>
              <table class="table">
                <thead><tr><th>Character</th><th>Lvl</th><th>+Kills</th></tr></thead>
                <tbody>{$topKills}</tbody>
              </table>
            </div>
            <div>
              <div class="muted" style="margin-bottom: 6px;">Top levels gained</div>
              <table class="table">
                <thead><tr><th>Character</th><th>Lvl</th><th>+Levels</th></tr></thead>
                <tbody>{$topLv}</tbody>
              </table>
            </div>
          </div>
        HTML;
      }

      $body = <<<HTML
      <div class="grid">
        <div class="panel">
          <div class="hd"><h2>{$mainTitle}</h2></div>
          <div class="bd">
            {$mainBody}
          </div>
        </div>
        <div>
          <div class="panel">
            <div class="hd"><h2>Realm</h2></div>
            <div class="bd">
              <div><strong>{$realmName}</strong></div>
              <div class="muted" style="margin-top:6px;">Connect: <span class="pill">{$realmAddr}:{$realmPort}</span></div>
              <div class="muted" style="margin-top:10px;">Snapshot: <span class="pill">{$snapshotDate}</span> (<span class="pill">{$snapshotRows}</span>)</div>
            </div>
          </div>
          <div class="panel" style="margin-top:14px;">
            <div class="hd"><h2>Password</h2></div>
            <div class="bd">
              <form method="post">
                <input type="hidden" name="csrf" value="{$csrf}" />
                <input type="hidden" name="action" value="change_password" />
                <label>New password (max 16 chars)</label>
                <input name="new_password" type="password" autocomplete="new-password" required />
                <div style="margin-top:12px;">
                  <button class="btn" type="submit">{$iconKey}Change Password</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      HTML;

      render($body, $flash, $flashKind);
    }

    ensureSession();
    requireCloudflareAccessIfEnabled();

    $flash = '';
    $flashKind = 'info';

    try {
      $pdo = db();
      $stats = getStats($pdo);
      $realm = getRealmInfo($pdo);
      $snap = getSnapshotInfo($pdo);

      if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $action = (string)($_POST['action'] ?? '');
        requireCsrf();

        if ($action === 'logout') {
          logout();
          header('Location: /');
          exit;
        }

        if ($action === 'login') {
          $loginUser = (string)($_POST['login_user'] ?? '');
          $loginPass = (string)($_POST['login_pass'] ?? '');
          $res = tryLogin($loginUser, $loginPass);
          session_regenerate_id(true);
          $_SESSION['account_id'] = $res['account_id'];
          $_SESSION['username'] = $res['username'];
          header('Location: /');
          exit;
        }

        if ($action === 'signup') {
          if (!isSignupEnabled()) {
            throw new RuntimeException("Sign up is disabled.");
          }
          $username = normalizeUsername((string)($_POST['username'] ?? ''));
          $password = validatePassword((string)($_POST['password'] ?? ''));
          $email = validateEmail((string)($_POST['email'] ?? ''));
          requireInviteCode((string)($_POST['invite'] ?? ''));
          soapExecute('account create ' . $username . ' ' . $password . ' ' . $email);
          $flash = "Created account: {$username}";
          $flashKind = 'ok';
        } elseif ($action === 'forum_create_thread') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          $categoryId = (int)($_POST['category_id'] ?? 0);
          if ($categoryId <= 0) {
            throw new RuntimeException("Invalid category.");
          }
          $category = getForumCategory($pdo, $categoryId);
          if ((int)$category['is_locked'] === 1) {
            throw new RuntimeException("Category is locked.");
          }
          $title = validateForumTitle((string)($_POST['title'] ?? ''));
          $body = validateForumBody((string)($_POST['body'] ?? ''));
          createForumThread($pdo, $categoryId, $title, $body, currentUsername(), currentAccountId());
          header('Location: /?tab=forum&f=' . $categoryId);
          exit;
        } elseif ($action === 'forum_reply') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          $threadId = (int)($_POST['thread_id'] ?? 0);
          if ($threadId <= 0) {
            throw new RuntimeException("Invalid thread.");
          }
          $thread = getForumThread($pdo, $threadId);
          if ((int)$thread['is_locked'] === 1) {
            throw new RuntimeException("Thread is locked.");
          }
          $body = validateForumBody((string)($_POST['body'] ?? ''));
          replyToForumThread($pdo, $threadId, $body, currentUsername(), currentAccountId());
          header('Location: /?tab=forum&t=' . $threadId);
          exit;
        } elseif ($action === 'forum_lock_thread' || $action === 'forum_unlock_thread' || $action === 'forum_pin_thread' || $action === 'forum_unpin_thread' || $action === 'forum_delete_thread') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          if (!isAdmin($pdo, currentAccountId())) {
            throw new RuntimeException("Admin access required.");
          }
          $threadId = (int)($_POST['thread_id'] ?? 0);
          if ($threadId <= 0) {
            throw new RuntimeException("Invalid thread.");
          }
          if ($action === 'forum_lock_thread') {
            setForumThreadFlag($pdo, $threadId, 'is_locked', 1);
          } elseif ($action === 'forum_unlock_thread') {
            setForumThreadFlag($pdo, $threadId, 'is_locked', 0);
          } elseif ($action === 'forum_pin_thread') {
            setForumThreadFlag($pdo, $threadId, 'is_pinned', 1);
          } elseif ($action === 'forum_unpin_thread') {
            setForumThreadFlag($pdo, $threadId, 'is_pinned', 0);
          } else {
            setForumThreadFlag($pdo, $threadId, 'is_deleted', 1);
          }
          $categoryId = (int)($_POST['f'] ?? 0);
          if ($categoryId > 0) {
            header('Location: /?tab=forum&f=' . $categoryId);
          } else {
            header('Location: /?tab=forum');
          }
          exit;
        } elseif ($action === 'forum_delete_post') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          if (!isAdmin($pdo, currentAccountId())) {
            throw new RuntimeException("Admin access required.");
          }
          $postId = (int)($_POST['post_id'] ?? 0);
          if ($postId <= 0) {
            throw new RuntimeException("Invalid post.");
          }
          deleteForumPost($pdo, $postId);
          $threadId = (int)($_POST['t'] ?? 0);
          if ($threadId > 0) {
            header('Location: /?tab=forum&t=' . $threadId);
            exit;
          }
          header('Location: /?tab=forum');
          exit;
        } elseif ($action === 'announce_create') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          if (!isAdmin($pdo, currentAccountId())) {
            throw new RuntimeException("Admin access required.");
          }
          $title = validateAnnouncementTitle((string)($_POST['announce_title'] ?? ''));
          $body = validateAnnouncementBody((string)($_POST['announce_body'] ?? ''));
          createAnnouncement($pdo, $title, $body, currentUsername());
          $flash = "Announcement posted.";
          $flashKind = 'ok';
        } elseif ($action === 'announce_delete') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          if (!isAdmin($pdo, currentAccountId())) {
            throw new RuntimeException("Admin access required.");
          }
          $id = (int)($_POST['announce_id'] ?? 0);
          if ($id <= 0) {
            throw new RuntimeException("Invalid announcement.");
          }
          deleteAnnouncement($pdo, $id);
          $flash = "Announcement removed.";
          $flashKind = 'ok';
        } elseif ($action === 'change_password') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          $newPass = validatePassword((string)($_POST['new_password'] ?? ''));
          $u = currentUsername();
          soapExecute('account set password ' . $u . ' ' . $newPass . ' ' . $newPass);
          $flash = "Password updated.";
          $flashKind = 'ok';
        } elseif ($action === 'rename' || $action === 'race_change' || $action === 'unstuck') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          $guid = (int)($_POST['guid'] ?? 0);
          if ($guid <= 0) {
            throw new RuntimeException("Invalid character.");
          }

          $char = characterBelongsTo($pdo, currentAccountId(), $guid);
          if ((int)$char['online'] === 1) {
            throw new RuntimeException("Character must be offline.");
          }

          if ($action === 'rename') {
            setAtLoginFlag($pdo, $guid, 0x01);
            $flash = "Rename queued for {$char['name']}.";
            $flashKind = 'ok';
          } elseif ($action === 'race_change') {
            setAtLoginFlag($pdo, $guid, 0x80);
            $flash = "Race change queued for {$char['name']}.";
            $flashKind = 'ok';
          } else {
            unstuckToGraveyard($pdo, $char);
            $flash = "Moved {$char['name']} to the nearest graveyard.";
            $flashKind = 'ok';
          }
        } elseif ($action === 'store_purchase') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          $guid = (int)($_POST['guid'] ?? 0);
          $itemId = (int)($_POST['item_id'] ?? 0);
          if ($guid <= 0 || $itemId <= 0) {
            throw new RuntimeException("Invalid purchase request.");
          }

          $catalog = [];
          foreach (storeItems() as $it) {
            $catalog[(int)$it['id']] = $it;
          }
          if (empty($catalog[$itemId])) {
            throw new RuntimeException("Unknown store item.");
          }
          $cost = (int)$catalog[$itemId]['cost'];

          $char = characterBelongsTo($pdo, currentAccountId(), $guid);
          if ((int)$char['online'] === 1) {
            throw new RuntimeException("Character must be offline.");
          }
          $charName = (string)$char['name'];
          if (isBotCharacter($pdo, $charName)) {
            throw new RuntimeException("Bot characters cannot use the store.");
          }

          $pdo->beginTransaction();
          try {
            $bal = tokenCount($pdo, $guid);
            if ($bal < $cost) {
              throw new RuntimeException("Not enough tokens.");
            }
            deductTokens($pdo, $guid, $cost);
            $pdo->commit();
          } catch (Throwable $e) {
            if ($pdo->inTransaction()) $pdo->rollBack();
            throw $e;
          }

          $subject = 'Grim Token Store';
          $body = 'Thanks for supporting the realm. Enjoy!';
          soapExecute('send items ' . $charName . ' "' . $subject . '" "' . $body . '" ' . $itemId . ':1');

          $flash = "Purchase delivered to {$charName}.";
          $flashKind = 'ok';
        } elseif ($action !== '') {
          throw new RuntimeException("Unknown action.");
        }
      }

      $tab = (string)($_GET['tab'] ?? (isLoggedIn() ? 'overview' : 'home'));

      if (!isLoggedIn()) {
        if ($tab === 'about') {
          renderAboutPage($realm, $flash, $flashKind);
        }
        if ($tab === 'server') {
          renderServerInfoPage($realm, $flash, $flashKind);
        }
        if ($tab === 'forum') {
          renderForumPage($pdo, false, $flash, $flashKind);
        }
        $announcements = listAnnouncements($pdo, 6);
        renderLoginPage($stats, $realm, $snap, $announcements, $flash, $flashKind);
      }

      if ($tab === 'server') {
        renderServerInfoPage($realm, $flash, $flashKind);
      }
      if ($tab === 'forum') {
        renderForumPage($pdo, true, $flash, $flashKind);
      }

      $announcements = listAnnouncements($pdo, 12);
      $chars = listCharacters($pdo, currentAccountId());
      renderPortal($pdo, $stats, $realm, $snap, $chars, $announcements, $flash, $flashKind);
    } catch (Throwable $e) {
      // If DB is down or extensions missing, render a simple page.
      $msg = $e->getMessage();
      render('<div class="panel"><div class="hd"><h2>Portal Error</h2></div><div class="bd"><div class="flash err">' . htmlspecialchars($msg) . '</div><div class="muted">If this is new, wait a minute after a rollout and refresh.</div></div></div>', 'Portal error', 'err');
    }
