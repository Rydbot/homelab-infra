apiVersion: v1
kind: ConfigMap
metadata:
  name: wotlk-accountmgr
  namespace: wotlk
data:
  index.php: |
    <?php
    declare(strict_types=1);

    function envOrDefault(string $key, string $default = ''): string {
      $val = getenv($key);
      return $val === false ? $default : $val;
    }

    function requestHeader(string $name): string {
      $key = 'HTTP_' . strtoupper(str_replace('-', '_', $name));
      return (string)($_SERVER[$key] ?? '');
    }

    function isHttpsRequest(): bool {
      // Behind Cloudflare Tunnel we’ll usually see HTTP at origin, with forwarded proto headers.
      $xfp = strtolower(requestHeader('X-Forwarded-Proto'));
      if ($xfp === 'https') return true;

      $cfv = requestHeader('CF-Visitor'); // e.g. {"scheme":"https"}
      if ($cfv !== '' && stripos($cfv, '"scheme":"https"') !== false) return true;

      $https = strtolower((string)($_SERVER['HTTPS'] ?? ''));
      return $https === 'on' || $https === '1';
    }

    function requireCloudflareAccessIfEnabled(): void {
      // Cloudflare Tunnel alone does NOT authenticate; Cloudflare Access does.
      // If enabled, require the Access JWT header to be present.
      if (envOrDefault('PORTAL_REQUIRE_CF_ACCESS', 'false') !== 'true') {
        return;
      }
      if (requestHeader('Cf-Access-Jwt-Assertion') === '') {
        http_response_code(403);
        echo "Forbidden (Cloudflare Access required).";
        exit;
      }
    }

    function isSignupEnabled(): bool {
      return envOrDefault('ALLOW_SIGNUP', 'false') === 'true';
    }

    function requireInviteCode(string $provided): void {
      $invite = envOrDefault('INVITE_CODE');
      if ($invite === '') {
        throw new RuntimeException("Server misconfigured: INVITE_CODE not set.");
      }
      if (!hash_equals($invite, trim($provided))) {
        throw new RuntimeException("Invalid invite code.");
      }
    }

    function requirePhpExt(string $ext): void {
      if (!extension_loaded($ext)) {
        throw new RuntimeException("Server misconfigured: missing PHP extension '{$ext}'.");
      }
    }

    function wowUpper(string $s): string {
      // AzerothCore SRP expects username/password already uppercased (latin only).
      // Keep this strict to avoid subtle mismatches with non-ASCII characters.
      if (preg_match('/[^\\x20-\\x7E]/', $s)) {
        throw new RuntimeException("Only ASCII characters are supported for login on this portal.");
      }
      return strtoupper($s);
    }

    function normalizeUsername(string $username): string {
      $username = trim($username);
      if (!preg_match('/^[A-Za-z0-9_]{3,32}$/', $username)) {
        throw new RuntimeException("Username must be 3-32 chars and only A-Z, 0-9, underscore.");
      }
      return wowUpper($username);
    }

    function validatePassword(string $password): string {
      if ($password === '') {
        throw new RuntimeException("Password is required.");
      }
      if (strlen($password) > 16) {
        // WoW client limit
        throw new RuntimeException("Password must be 16 characters or less.");
      }
      return $password;
    }

    function validateEmail(string $email): string {
      $email = trim($email);
      if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        throw new RuntimeException("Email is invalid.");
      }
      if (strlen($email) > 255) {
        throw new RuntimeException("Email is too long.");
      }
      return $email;
    }

    function db(): PDO {
      requirePhpExt('pdo');
      requirePhpExt('pdo_mysql');

      $host = envOrDefault('DB_HOST');
      $port = envOrDefault('DB_PORT', '3306');
      $user = envOrDefault('DB_USER');
      $pass = envOrDefault('DB_PASSWORD');

      if ($host === '' || $user === '') {
        throw new RuntimeException("Server misconfigured: DB_HOST/DB_USER not set.");
      }

      $dsn = "mysql:host={$host};port={$port};charset=utf8mb4";
      return new PDO($dsn, $user, $pass, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
      ]);
    }

    function dbName(string $envKey, string $fallback): string {
      $v = envOrDefault($envKey, $fallback);
      if (!preg_match('/^[A-Za-z0-9_]+$/', $v)) {
        throw new RuntimeException("Server misconfigured: invalid {$envKey}.");
      }
      return $v;
    }

    function gmpFromLE(string $bytes): GMP {
      requirePhpExt('gmp');
      // word_size=1 + LSW_FIRST == little-endian bytes
      /** @var GMP $n */
      $n = gmp_import($bytes, 1, GMP_LSW_FIRST);
      return $n;
    }

    function gmpToLE(GMP $n, int $padLen): string {
      $b = gmp_export($n, 1, GMP_LSW_FIRST);
      if ($b === false) {
        $b = '';
      }
      if (strlen($b) > $padLen) {
        $b = substr($b, 0, $padLen);
      }
      return str_pad($b, $padLen, "\0", STR_PAD_RIGHT);
    }

    function srp6Verifier(string $usernameUpper, string $passwordUpper, string $salt32): string {
      // Matches AzerothCore SRP6::CalculateVerifier (little-endian BigNumber bytes in DB).
      // N (hex) is big-endian; AzerothCore stores it reversed in SRP6.cpp.
      $Nhex = '894B645E89E1535BBDAD5B8B290650530801B18EBFBF5E8FAB3C82872A3E9BB7';
      $N = gmpFromLE(strrev(hex2bin($Nhex)));
      $g = gmp_init(7, 10);

      $inner = sha1($usernameUpper . ':' . $passwordUpper, true);
      $x = sha1($salt32 . $inner, true); // 20 bytes
      $xInt = gmpFromLE($x);

      /** @var GMP $v */
      $v = gmp_powm($g, $xInt, $N);
      return gmpToLE($v, 32);
    }

    function tryLogin(string $username, string $password): array {
      $usernameUpper = normalizeUsername($username);
      $passwordUpper = wowUpper(validatePassword($password));

      $pdo = db();
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $stmt = $pdo->prepare("SELECT id, username, salt, verifier FROM {$authDb}.account WHERE username = :u LIMIT 1");
      $stmt->execute([':u' => $usernameUpper]);
      $row = $stmt->fetch();
      if (!$row) {
        throw new RuntimeException("Invalid username or password.");
      }

      $salt = (string)$row['salt'];
      $verifier = (string)$row['verifier'];
      if (strlen($salt) !== 32 || strlen($verifier) !== 32) {
        throw new RuntimeException("Server misconfigured: SRP fields have unexpected lengths.");
      }

      $calc = srp6Verifier($usernameUpper, $passwordUpper, $salt);
      if (!hash_equals($verifier, $calc)) {
        throw new RuntimeException("Invalid username or password.");
      }

      return [
        'account_id' => (int)$row['id'],
        'username' => (string)$row['username'],
      ];
    }

    function soapExecute(string $command): string {
      $soapUrl = envOrDefault('SOAP_URL', 'http://127.0.0.1:7878/');
      $soapUser = envOrDefault('SOAP_USERNAME');
      $soapPass = envOrDefault('SOAP_PASSWORD');

      if ($soapUser === '' || $soapPass === '') {
        throw new RuntimeException("Server misconfigured: SOAP_USERNAME/SOAP_PASSWORD not set.");
      }

      $envelope =
        '<?xml version="1.0" encoding="utf-8"?>' .
        '<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">' .
        '<SOAP-ENV:Body>' .
        '<executeCommand xmlns="urn:AC">' .
        '<command>' . htmlspecialchars($command, ENT_XML1 | ENT_QUOTES, 'UTF-8') . '</command>' .
        '</executeCommand>' .
        '</SOAP-ENV:Body>' .
        '</SOAP-ENV:Envelope>';

      $headers = [
        'Content-Type: text/xml; charset=utf-8',
        'SOAPAction: "urn:AC#executeCommand"',
      ];

      $context = stream_context_create([
        'http' => [
          'method' => 'POST',
          'header' => implode("\r\n", array_merge($headers, [
            'Authorization: Basic ' . base64_encode($soapUser . ':' . $soapPass),
          ])),
          'content' => $envelope,
          'timeout' => 10,
        ],
      ]);

      $attempts = 20;
      for ($i = 1; $i <= $attempts; $i++) {
        $resp = @file_get_contents($soapUrl, false, $context);
        if ($resp !== false) {
          return $resp;
        }

        $err = error_get_last();
        $msg = $err['message'] ?? 'request failed';

        if (strpos($msg, 'Connection refused') !== false) {
          usleep(500000);
          continue;
        }

        throw new RuntimeException("SOAP request failed: " . $msg);
      }

      throw new RuntimeException("SOAP request failed: worldserver SOAP not ready (timed out).");
    }

    function ensureSession(): void {
      if (session_status() !== PHP_SESSION_ACTIVE) {
        ini_set('session.use_strict_mode', '1');
        ini_set('session.use_only_cookies', '1');
        ini_set('session.cookie_httponly', '1');
        ini_set('session.cookie_samesite', 'Lax');
        if (isHttpsRequest()) {
          ini_set('session.cookie_secure', '1');
        }
        session_start();
      }
      if (empty($_SESSION['csrf'])) {
        $_SESSION['csrf'] = bin2hex(random_bytes(16));
      }
    }

    function csrfToken(): string {
      ensureSession();
      return (string)$_SESSION['csrf'];
    }

    function requireCsrf(): void {
      ensureSession();
      $sent = (string)($_POST['csrf'] ?? '');
      if ($sent === '' || !hash_equals((string)$_SESSION['csrf'], $sent)) {
        throw new RuntimeException("Invalid CSRF token. Refresh and try again.");
      }
    }

    function isLoggedIn(): bool {
      ensureSession();
      return !empty($_SESSION['account_id']) && !empty($_SESSION['username']);
    }

    function currentAccountId(): int {
      ensureSession();
      return (int)($_SESSION['account_id'] ?? 0);
    }

    function currentUsername(): string {
      ensureSession();
      return (string)($_SESSION['username'] ?? '');
    }

    function logout(): void {
      ensureSession();
      $_SESSION = [];
      if (ini_get('session.use_cookies')) {
        $params = session_get_cookie_params();
        setcookie(session_name(), '', time() - 42000, $params['path'], $params['domain'], $params['secure'], $params['httponly']);
      }
      session_destroy();
    }

    function render(string $bodyHtml, string $flash = '', string $flashKind = 'info'): void {
      // We intentionally avoid using Blizzard trademarks/logos. This is a "2004-era Battle.net inspired" theme.
      $title = 'Account Management';
      $flashHtml = '';
      if ($flash !== '') {
        $flashHtml = '<div class="flash ' . htmlspecialchars($flashKind) . '">' . htmlspecialchars($flash) . '</div>';
      }

      $userChip = '';
      if (isLoggedIn()) {
        $userChip = '<div class="user">Signed in as <strong>' . htmlspecialchars(currentUsername()) . '</strong></div>';
      }

      $orbSvg = <<<SVG
      <svg viewBox="0 0 64 64" width="36" height="36" aria-hidden="true" focusable="false">
        <defs>
          <radialGradient id="g1" cx="30%" cy="28%" r="70%">
            <stop offset="0%" stop-color="#ffe7b0" stop-opacity="0.35"/>
            <stop offset="55%" stop-color="#4fc3f7" stop-opacity="0.18"/>
            <stop offset="100%" stop-color="#061225" stop-opacity="0"/>
          </radialGradient>
          <linearGradient id="g2" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#1b3e6a"/>
            <stop offset="100%" stop-color="#081428"/>
          </linearGradient>
        </defs>
        <circle cx="32" cy="32" r="28" fill="url(#g2)" stroke="#f0cf84" stroke-opacity="0.55" stroke-width="1.5"/>
        <circle cx="32" cy="32" r="26" fill="url(#g1)" />
        <path d="M18 35c4 8 20 11 28 2" fill="none" stroke="#8fd2ff" stroke-opacity="0.55" stroke-width="2" stroke-linecap="round"/>
        <path d="M22 28c6-10 20-12 24-2" fill="none" stroke="#ffe1a3" stroke-opacity="0.35" stroke-width="2" stroke-linecap="round"/>
      </svg>
      SVG;

      $tab = (string)($_GET['tab'] ?? (isLoggedIn() ? 'overview' : 'home'));
      $tabs = isLoggedIn()
        ? [
            'overview' => 'My Account',
            'characters' => 'Characters',
            'services' => 'Services',
            'stats' => 'Stats',
            'arena' => 'Arena',
          ]
        : [
            'home' => 'Home',
            'stats' => 'Stats',
          ];

      $tabLinks = '';
      foreach ($tabs as $k => $label) {
        $active = $k === $tab ? ' active' : '';
        $tabLinks .= '<a class="tab' . $active . '" href="/?tab=' . urlencode($k) . '">' . htmlspecialchars($label) . '</a>';
      }

      echo <<<HTML
    <!doctype html>
    <html lang="en">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>{$title}</title>
      <style>
        :root { color-scheme: dark; }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          font-family: Tahoma, Verdana, Arial, sans-serif;
          color: #efe2c1;
          background:
            radial-gradient(1200px 700px at 50% -10%, rgba(48, 137, 245, .22), rgba(0,0,0,0)),
            radial-gradient(900px 500px at 30% 10%, rgba(255, 205, 105, .14), rgba(0,0,0,0)),
            radial-gradient(900px 600px at 70% 15%, rgba(255, 255, 255, .06), rgba(0,0,0,0)),
            linear-gradient(180deg, #091328, #02060c);
        }
        .noise:before {
          content:"";
          position: fixed;
          inset: 0;
          pointer-events: none;
          background-image:
            repeating-linear-gradient(0deg, rgba(255,255,255,.03), rgba(255,255,255,.03) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 4px);
          mix-blend-mode: overlay;
          opacity: .12;
        }
        a { color: #9bd7ff; }
        .wrap { max-width: 980px; margin: 0 auto; padding: 20px 14px 56px; }
        .topbar {
          display: flex; align-items: center; justify-content: space-between; gap: 10px;
          border: 1px solid rgba(255, 221, 148, .22);
          border-radius: 12px;
          background:
            linear-gradient(180deg, rgba(44, 29, 14, .55), rgba(12, 8, 4, .75)),
            linear-gradient(180deg, rgba(18, 55, 96, .35), rgba(7, 18, 35, .35));
          box-shadow: 0 24px 50px rgba(0,0,0,.45);
          padding: 12px 14px;
        }
        .brand {
          display:flex; align-items:center; gap: 12px;
        }
        .logo { width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; }
        .brand h1 { margin: 0; font-size: 15px; letter-spacing: .3px; color: #ffe1a3; }
        .brand .sub { opacity: .75; font-size: 12px; margin-top: 2px; color: #cbb58f; }
        .user { font-size: 12px; opacity: .85; text-align: right; color: #d7c6a6; }
        .tabs {
          margin-top: 10px;
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
          padding: 8px;
          border: 1px solid rgba(255, 221, 148, .14);
          border-radius: 12px;
          background:
            linear-gradient(180deg, rgba(42, 28, 14, .70), rgba(12, 8, 4, .70));
          box-shadow: 0 20px 45px rgba(0,0,0,.35);
        }
        .tab {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 8px 10px;
          border-radius: 10px;
          border: 1px solid rgba(255, 221, 148, .12);
          background: rgba(0,0,0,.18);
          color: #efe2c1;
          text-decoration: none;
          font-weight: 700;
          letter-spacing: .15px;
          font-size: 12px;
        }
        .tab:hover { filter: brightness(1.05); }
        .tab.active {
          border-color: rgba(255, 221, 148, .28);
          background:
            linear-gradient(180deg, rgba(22, 86, 142, .50), rgba(10, 34, 60, .45));
          color: #ffe7b0;
        }
        .grid { display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 14px; }
        @media (min-width: 920px) { .grid { grid-template-columns: 1.25fr .75fr; } }
        .panel {
          border: 1px solid rgba(255, 221, 148, .18);
          border-radius: 12px;
          background:
            linear-gradient(180deg, rgba(38, 26, 14, .92), rgba(10, 7, 4, .92));
          box-shadow: 0 24px 55px rgba(0,0,0,.48);
          overflow: hidden;
        }
        .panel .hd {
          padding: 12px 14px;
          border-bottom: 1px solid rgba(255, 221, 148, .14);
          background:
            linear-gradient(180deg, rgba(20, 60, 108, .35), rgba(10, 24, 45, .10)),
            linear-gradient(180deg, rgba(60, 40, 18, .55), rgba(20, 14, 7, .35));
        }
        .panel .hd h2 { margin: 0; font-size: 13px; letter-spacing: .35px; color: #ffe1a3; text-transform: uppercase; }
        .panel .bd { padding: 14px; }
        .flash {
          margin-top: 12px;
          border-radius: 10px;
          padding: 10px 12px;
          border: 1px solid rgba(255, 221, 148, .14);
          background: rgba(0,0,0,.18);
        }
        .flash.ok { border-color: rgba(34,197,94,.4); }
        .flash.err { border-color: rgba(239,68,68,.4); }
        label { display:block; margin: 10px 0 6px; font-size: 12px; opacity: .9; color: #d7c6a6; }
        input, select {
          width: 100%;
          padding: 10px 12px;
          border-radius: 10px;
          border: 1px solid rgba(255, 221, 148, .16);
          background: rgba(0,0,0,.28);
          color: #efe2c1;
        }
        .btn {
          display:inline-flex; align-items:center; justify-content:center;
          gap: 8px;
          padding: 9px 12px;
          border-radius: 10px;
          border: 1px solid rgba(255, 221, 148, .22);
          background:
            linear-gradient(180deg, rgba(22, 86, 142, .70), rgba(10, 34, 60, .75));
          color: #ffe7b0;
          font-weight: 700;
          cursor: pointer;
        }
        .btn:hover { filter: brightness(1.05); }
        .btn.secondary { background: rgba(0,0,0,.18); border-color: rgba(255, 221, 148, .14); font-weight: 600; color: #efe2c1; }
        .btn.danger { background: linear-gradient(180deg, rgba(160, 22, 22, .75), rgba(80, 12, 12, .75)); border-color: rgba(239, 68, 68, .35); color: #ffe1a3; }
        .btn svg { width: 14px; height: 14px; opacity: .95; }
        .classpill {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 18px;
          height: 18px;
          border-radius: 6px;
          border: 1px solid rgba(255, 221, 148, .18);
          background:
            radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(0,0,0,0) 60%),
            linear-gradient(180deg, color-mix(in srgb, var(--c) 55%, #000 45%), rgba(0,0,0,.55));
          color: #fff;
          font-weight: 900;
          font-size: 11px;
          text-shadow: 0 1px 2px rgba(0,0,0,.6);
          vertical-align: middle;
          margin-right: 6px;
        }
        .classpill.unk { --c: #64748b; }
        .classpill.war { --c: #C79C6E; }  /* Warrior */
        .classpill.pal { --c: #F58CBA; }  /* Paladin */
        .classpill.hun { --c: #ABD473; }  /* Hunter */
        .classpill.rog { --c: #FFF569; }  /* Rogue */
        .classpill.pri { --c: #FFFFFF; }  /* Priest */
        .classpill.dkn { --c: #C41F3B; }  /* Death Knight */
        .classpill.sha { --c: #0070DE; }  /* Shaman */
        .classpill.mag { --c: #69CCF0; }  /* Mage */
        .classpill.wlk { --c: #9482C9; }  /* Warlock */
        .classpill.dru { --c: #FF7D0A; }  /* Druid */
        .row { display:flex; gap: 10px; align-items: center; }
        .row > * { flex: 1; }
        .table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .table th, .table td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,.08); vertical-align: top; }
        .table th { text-align: left; color: #ffe1a3; font-weight: 700; letter-spacing: .25px; }
        .muted { opacity: .75; color: #cbb58f; }
        .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(255, 221, 148, .14); background: rgba(0,0,0,.18); }
        .kpi { display:flex; gap: 10px; flex-wrap: wrap; }
        .kpi .card { flex: 1; min-width: 160px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255, 221, 148, .14); background: rgba(0,0,0,.18); }
        .kpi .val { font-size: 20px; font-weight: 800; color: #9bd7ff; margin-top: 4px; }
        .foot { margin-top: 16px; font-size: 12px; opacity: .7; }
      </style>
    </head>
    <body class="noise">
      <div class="wrap">
        <div class="topbar">
          <div class="brand">
            <div class="logo">{$orbSvg}</div>
            <div>
              <h1>{$title}</h1>
              <div class="sub">Grim Guzzler • Wrath 3.3.5a</div>
            </div>
          </div>
          {$userChip}
        </div>
        <nav class="tabs" aria-label="Primary">
          {$tabLinks}
        </nav>
        {$flashHtml}
        {$bodyHtml}
        <div class="foot">Tip: characters must be offline for rename/race change/unstuck to apply safely.</div>
      </div>
    </body>
    </html>
    HTML;
      exit;
    }

    function ensureStatsTable(PDO $pdo): void {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $pdo->exec(
        "CREATE TABLE IF NOT EXISTS {$charDb}.web_stats_daily (" .
        "snapshot_date DATE NOT NULL," .
        "guid INT UNSIGNED NOT NULL," .
        "name VARCHAR(12) NOT NULL," .
        "class TINYINT UNSIGNED NOT NULL," .
        "level TINYINT UNSIGNED NOT NULL," .
        "total_kills INT UNSIGNED NOT NULL," .
        "PRIMARY KEY (snapshot_date, guid)," .
        "KEY guid_idx (guid)," .
        "KEY date_idx (snapshot_date)" .
        ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4"
      );
      // Migrate older table versions (MySQL compatibility: avoid ADD COLUMN IF NOT EXISTS).
      $stmt = $pdo->prepare(
        "SELECT COUNT(*) AS c FROM information_schema.COLUMNS " .
        "WHERE TABLE_SCHEMA = :db AND TABLE_NAME = 'web_stats_daily' AND COLUMN_NAME = 'class'"
      );
      $stmt->execute([':db' => $charDb]);
      $has = (int)$stmt->fetch()['c'];
      if ($has === 0) {
        $pdo->exec("ALTER TABLE {$charDb}.web_stats_daily ADD COLUMN class TINYINT UNSIGNED NOT NULL DEFAULT 0 AFTER name");
      }
    }

    function classPill(int $class): string {
      $map = [
        1 => ['war', 'W'],
        2 => ['pal', 'P'],
        3 => ['hun', 'H'],
        4 => ['rog', 'R'],
        5 => ['pri', 'P'],
        6 => ['dkn', 'D'],
        7 => ['sha', 'S'],
        8 => ['mag', 'M'],
        9 => ['wlk', 'W'],
        11 => ['dru', 'D'],
      ];
      $m = $map[$class] ?? ['unk', '?'];
      return '<span class="classpill ' . $m[0] . '">' . $m[1] . '</span>';
    }

    function getRealmInfo(PDO $pdo): array {
      $authDb = dbName('DB_AUTH_DB', 'acore_auth');
      $realmId = (int)envOrDefault('REALM_ID', '1');
      $stmt = $pdo->prepare("SELECT id, name, address, port FROM {$authDb}.realmlist WHERE id = :id LIMIT 1");
      $stmt->execute([':id' => $realmId]);
      $row = $stmt->fetch();
      if (!$row) {
        return ['name' => 'Unknown', 'address' => '', 'port' => 0];
      }
      return [
        'name' => (string)$row['name'],
        'address' => (string)$row['address'],
        'port' => (int)$row['port'],
      ];
    }

    function getSnapshotInfo(PDO $pdo): array {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      ensureStatsTable($pdo);
      $last = $pdo->query("SELECT MAX(snapshot_date) AS d FROM {$charDb}.web_stats_daily")->fetch();
      $d = $last && $last['d'] ? (string)$last['d'] : '';
      $rows = 0;
      if ($d !== '') {
        $stmt = $pdo->prepare("SELECT COUNT(*) AS c FROM {$charDb}.web_stats_daily WHERE snapshot_date = :d");
        $stmt->execute([':d' => $d]);
        $rows = (int)$stmt->fetch()['c'];
      }
      return ['date' => $d, 'rows' => $rows];
    }

    function getStats(PDO $pdo): array {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      ensureStatsTable($pdo);

      $playersOnline = (int)$pdo->query("SELECT COUNT(*) AS c FROM {$charDb}.characters WHERE online = 1")->fetch()['c'];

      $topKills = [];
      $topLevels = [];

      // These depend on the periodic snapshot job. If it hasn't run yet, tables will be empty.
      $topKillsStmt = $pdo->query(
        "SELECT MAX(name) AS name, MAX(class) AS class, MAX(level) AS level, (MAX(total_kills) - MIN(total_kills)) AS gained " .
        "FROM {$charDb}.web_stats_daily " .
        "WHERE snapshot_date >= (CURRENT_DATE - INTERVAL 7 DAY) " .
        "GROUP BY guid " .
        "HAVING gained > 0 " .
        "ORDER BY gained DESC " .
        "LIMIT 10"
      );
      $topKills = $topKillsStmt->fetchAll();

      $topLevelsStmt = $pdo->query(
        "SELECT MAX(name) AS name, MAX(class) AS class, MAX(level) AS level, (MAX(level) - MIN(level)) AS gained " .
        "FROM {$charDb}.web_stats_daily " .
        "WHERE snapshot_date >= (CURRENT_DATE - INTERVAL 7 DAY) " .
        "GROUP BY guid " .
        "HAVING gained > 0 " .
        "ORDER BY gained DESC " .
        "LIMIT 10"
      );
      $topLevels = $topLevelsStmt->fetchAll();

      return [
        'players_online' => $playersOnline,
        'top_kills' => $topKills,
        'top_levels' => $topLevels,
      ];
    }

    function listCharacters(PDO $pdo, int $accountId): array {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $stmt = $pdo->prepare(
        "SELECT guid, name, race, class, level, online, at_login, zone, map " .
        "FROM {$charDb}.characters WHERE account = :a ORDER BY level DESC, name ASC"
      );
      $stmt->execute([':a' => $accountId]);
      return $stmt->fetchAll();
    }

    function characterBelongsTo(PDO $pdo, int $accountId, int $guid): array {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $stmt = $pdo->prepare(
        "SELECT guid, account, name, race, class, level, online, at_login, zone, map " .
        "FROM {$charDb}.characters WHERE guid = :g LIMIT 1"
      );
      $stmt->execute([':g' => $guid]);
      $row = $stmt->fetch();
      if (!$row || (int)$row['account'] !== $accountId) {
        throw new RuntimeException("Character not found.");
      }
      return $row;
    }

    function setAtLoginFlag(PDO $pdo, int $guid, int $bit): void {
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');
      $stmt = $pdo->prepare("UPDATE {$charDb}.characters SET at_login = (at_login | :bit) WHERE guid = :g");
      $stmt->execute([':bit' => $bit, ':g' => $guid]);
    }

    function getTeamFactionForRace(int $race): int {
      // AzerothCore: graveyard_zone.Faction is 469 (Alliance), 67 (Horde), 0 (any)
      $alliance = [1, 3, 4, 7, 11];
      return in_array($race, $alliance, true) ? 469 : 67;
    }

    function unstuckToGraveyard(PDO $pdo, array $char): void {
      $worldDb = dbName('DB_WORLD_DB', 'acore_world');
      $charDb = dbName('DB_CHAR_DB', 'acore_characters');

      $zone = (int)$char['zone'];
      $race = (int)$char['race'];
      $guid = (int)$char['guid'];
      $faction = getTeamFactionForRace($race);

      $stmt = $pdo->prepare(
        "SELECT g.Map AS map, g.x, g.y, g.z " .
        "FROM {$worldDb}.graveyard_zone gz " .
        "JOIN {$worldDb}.game_graveyard g ON g.ID = gz.ID " .
        "WHERE gz.GhostZone = :z AND (gz.Faction = 0 OR gz.Faction = :f) " .
        "ORDER BY (gz.Faction = 0) ASC, gz.ID ASC " .
        "LIMIT 1"
      );
      $stmt->execute([':z' => $zone, ':f' => $faction]);
      $gy = $stmt->fetch();
      if (!$gy) {
        throw new RuntimeException("No graveyard mapping found for zone {$zone}.");
      }

      $upd = $pdo->prepare(
        "UPDATE {$charDb}.characters " .
        "SET map = :map, position_x = :x, position_y = :y, position_z = :z, " .
        "trans_x = 0, trans_y = 0, trans_z = 0, trans_o = 0, transguid = 0 " .
        "WHERE guid = :g"
      );
      $upd->execute([
        ':map' => (int)$gy['map'],
        ':x' => (float)$gy['x'],
        ':y' => (float)$gy['y'],
        ':z' => (float)$gy['z'],
        ':g' => $guid,
      ]);
    }

    function renderLoginPage(array $stats, array $realm, array $snap, string $flash = '', string $flashKind = 'info'): void {
      $csrf = htmlspecialchars(csrfToken());
      $online = (int)$stats['players_online'];

      $iconLogin = '<svg viewBox="0 0 24 24" fill="none"><path d="M14 7V5a2 2 0 0 0-2-2H5v18h7a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M21 12H11m0 0 3-3m-3 3 3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';

      $ann = trim(envOrDefault('PORTAL_ANNOUNCEMENTS', 'Welcome to Grim Guzzler.'));
      $annHtml = nl2br(htmlspecialchars($ann));
      $realmName = htmlspecialchars((string)($realm['name'] ?? 'Unknown'));
      $realmAddr = htmlspecialchars((string)($realm['address'] ?? ''));
      $realmPort = (int)($realm['port'] ?? 0);
      $snapshotDate = htmlspecialchars((string)($snap['date'] ?? ''));
      $snapshotRows = (int)($snap['rows'] ?? 0);

      $githubRepo = envOrDefault('PORTAL_GITHUB_REPO', 'RovxBot/homelab-infra');
      $githubBranch = envOrDefault('PORTAL_GITHUB_BRANCH', 'main');
      $githubRepoSafe = preg_match('/^[A-Za-z0-9_.-]+\\/[A-Za-z0-9_.-]+$/', $githubRepo) ? $githubRepo : 'RovxBot/homelab-infra';
      $githubBranchSafe = preg_match('/^[A-Za-z0-9_.\\/-]+$/', $githubBranch) ? $githubBranch : 'main';
      $commitsPage = 'https://github.com/' . $githubRepoSafe . '/commits/' . rawurlencode($githubBranchSafe);

      $commits = [];
      try {
        ensureSession();
        $cacheKey = 'commits_cache';
        $cacheAtKey = 'commits_cache_at';
        $cacheTtl = 60; // seconds

        $now = time();
        if (!empty($_SESSION[$cacheKey]) && !empty($_SESSION[$cacheAtKey]) && ($now - (int)$_SESSION[$cacheAtKey]) < $cacheTtl) {
          $commits = (array)$_SESSION[$cacheKey];
        } else {
          $api = 'https://api.github.com/repos/' . $githubRepoSafe . '/commits?per_page=6&sha=' . rawurlencode($githubBranchSafe);
          $ctx = stream_context_create([
            'http' => [
              'method' => 'GET',
              'timeout' => 2,
              'header' => implode("\r\n", [
                'Accept: application/vnd.github+json',
                'User-Agent: grimguzzler-portal',
              ]),
            ],
          ]);
          $json = @file_get_contents($api, false, $ctx);
          if ($json !== false) {
            $data = json_decode($json, true, 512, JSON_THROW_ON_ERROR);
            if (is_array($data)) {
              foreach ($data as $c) {
                if (!is_array($c)) continue;
                $sha = (string)($c['sha'] ?? '');
                $htmlUrl = (string)($c['html_url'] ?? '');
                $msg = (string)($c['commit']['message'] ?? '');
                $date = (string)($c['commit']['committer']['date'] ?? '');
                if ($sha === '' || $htmlUrl === '' || $msg === '') continue;
                $firstLine = trim(explode("\n", $msg, 2)[0]);
                $commits[] = [
                  'sha' => substr($sha, 0, 7),
                  'url' => $htmlUrl,
                  'msg' => $firstLine,
                  'date' => $date,
                ];
              }
            }
          }
          $_SESSION[$cacheKey] = $commits;
          $_SESSION[$cacheAtKey] = $now;
        }
      } catch (Throwable $e) {
        $commits = [];
      }

      $commitsRows = '';
      foreach ($commits as $c) {
        $msg = htmlspecialchars((string)($c['msg'] ?? ''));
        $sha = htmlspecialchars((string)($c['sha'] ?? ''));
        $url = htmlspecialchars((string)($c['url'] ?? ''));
        $date = htmlspecialchars((string)($c['date'] ?? ''));
        if ($msg === '' || $sha === '' || $url === '') continue;
        $commitsRows .= '<tr><td><a href="' . $url . '" target="_blank" rel="noreferrer">' . $msg . '</a><div class="muted" style="margin-top:4px;"><span class="pill">' . $sha . '</span> <span class="pill">' . $date . '</span></div></td></tr>';
      }
      if ($commitsRows === '') {
        $commitsRows = '<tr><td class="muted">Unable to load recent commits right now. <a href="' . htmlspecialchars($commitsPage) . '" target="_blank" rel="noreferrer">View commit history</a>.</td></tr>';
      }

      $topKillsRows = '';
      foreach ($stats['top_kills'] as $r) {
        $name = htmlspecialchars((string)($r['name'] ?? ''));
        $class = (int)($r['class'] ?? 0);
        $level = (int)($r['level'] ?? 0);
        $gained = (int)($r['gained'] ?? 0);
        $topKillsRows .= '<tr><td>' . classPill($class) . $name . '</td><td><span class="pill">' . $level . '</span></td><td><span class="pill">' . $gained . '</span></td></tr>';
      }
      if ($topKillsRows === '') {
        $topKillsRows = '<tr><td colspan="3" class="muted">Not enough data yet (snapshot job needs to run).</td></tr>';
      }

      $topLevelsRows = '';
      foreach ($stats['top_levels'] as $r) {
        $name = htmlspecialchars((string)($r['name'] ?? ''));
        $class = (int)($r['class'] ?? 0);
        $level = (int)($r['level'] ?? 0);
        $gained = (int)($r['gained'] ?? 0);
        $topLevelsRows .= '<tr><td>' . classPill($class) . $name . '</td><td><span class="pill">' . $level . '</span></td><td><span class="pill">+' . $gained . '</span></td></tr>';
      }
      if ($topLevelsRows === '') {
        $topLevelsRows = '<tr><td colspan="3" class="muted">Not enough data yet (snapshot job needs to run).</td></tr>';
      }

      $signup = '';
      if (isSignupEnabled()) {
        $signup = <<<HTML
        <div class="panel">
          <div class="hd"><h2>Create Account (Invite)</h2></div>
          <div class="bd">
            <form method="post">
              <input type="hidden" name="csrf" value="{$csrf}" />
              <input type="hidden" name="action" value="signup" />
              <label>Username</label>
              <input name="username" autocomplete="username" required />
              <label>Password (max 16 chars)</label>
              <input name="password" type="password" autocomplete="new-password" required />
              <label>Email</label>
              <input name="email" type="email" autocomplete="email" required />
              <label>Invite code</label>
              <input name="invite" required />
              <div style="margin-top:12px;">
                <button class="btn" type="submit">Create account</button>
              </div>
            </form>
          </div>
        </div>
        HTML;
      }

      $body = <<<HTML
      <div class="grid">
        <div>
          <div class="panel">
            <div class="hd"><h2>Announcements</h2></div>
            <div class="bd">
              <div style="margin-top:2px;">{$annHtml}</div>
              <div class="muted" style="margin-top:12px;">Recent updates</div>
              <table class="table" style="margin-top:6px;">
                <tbody>{$commitsRows}</tbody>
              </table>
              <div class="muted" style="margin-top:10px;"><a href="{$commitsPage}" target="_blank" rel="noreferrer">View all commits</a></div>
            </div>
          </div>
          <div class="panel" style="margin-top:14px;">
            <div class="hd"><h2>Weekly Stats</h2></div>
            <div class="bd">
              <div class="muted" style="margin-bottom: 10px;">Last 7 days (best effort).</div>
              <div class="row" style="align-items:flex-start;">
                <div>
                  <div class="muted" style="margin-bottom: 6px;">Top PvP kills</div>
                  <table class="table">
                    <thead><tr><th>Character</th><th>Lvl</th><th>+Kills</th></tr></thead>
                    <tbody>{$topKillsRows}</tbody>
                  </table>
                </div>
                <div>
                  <div class="muted" style="margin-bottom: 6px;">Top levels gained</div>
                  <table class="table">
                    <thead><tr><th>Character</th><th>Lvl</th><th>+Levels</th></tr></thead>
                    <tbody>{$topLevelsRows}</tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div>
          <div class="panel">
            <div class="hd"><h2>Sign In</h2></div>
            <div class="bd">
              <div class="kpi">
                <div class="card">
                  <div class="muted">Players online</div>
                  <div class="val">{$online}</div>
                </div>
              </div>
              <form method="post" style="margin-top:14px;">
                <input type="hidden" name="csrf" value="{$csrf}" />
                <input type="hidden" name="action" value="login" />
                <label>Account name</label>
                <input name="login_user" autocomplete="username" required />
                <label>Password</label>
                <input name="login_pass" type="password" autocomplete="current-password" required />
                <div style="margin-top:12px;">
                  <button class="btn" type="submit">{$iconLogin}Log In</button>
                </div>
              </form>
            </div>
          </div>
          <div class="panel" style="margin-top:14px;">
            <div class="hd"><h2>Realm Status</h2></div>
            <div class="bd">
              <div><strong>{$realmName}</strong></div>
              <div class="muted" style="margin-top:6px;">Connect: <span class="pill">{$realmAddr}:{$realmPort}</span></div>
              <div class="muted" style="margin-top:10px;">Snapshot: <span class="pill">{$snapshotDate}</span> (<span class="pill">{$snapshotRows}</span> rows)</div>
            </div>
          </div>
          {$signup}
        </div>
      </div>
      HTML;

      render($body, $flash, $flashKind);
    }

    function renderPortal(PDO $pdo, array $stats, array $realm, array $snap, array $chars, string $flash = '', string $flashKind = 'info'): void {
      $csrf = htmlspecialchars(csrfToken());
      $online = (int)$stats['players_online'];
      $tab = (string)($_GET['tab'] ?? 'overview');
      if (!in_array($tab, ['overview', 'characters', 'services', 'stats', 'arena'], true)) {
        $tab = 'overview';
      }

      $iconLogout = '<svg viewBox="0 0 24 24" fill="none"><path d="M10 7V5a2 2 0 0 1 2-2h7v18h-7a2 2 0 0 1-2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M3 12h10m0 0-3-3m3 3-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      $iconKey = '<svg viewBox="0 0 24 24" fill="none"><path d="M7.5 14.5a5.5 5.5 0 1 1 4.9-8H22v4h-2v2h-2v2h-2.6A5.5 5.5 0 0 1 7.5 14.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M7.5 10.5h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>';
      $iconQuill = '<svg viewBox="0 0 24 24" fill="none"><path d="M20 4c-7 2-12 7-14 14l-2 2 4-1c7-2 12-7 14-14-1-1-1-1-2-1Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M9 15l-1 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
      $iconMask = '<svg viewBox="0 0 24 24" fill="none"><path d="M4 7c4-3 12-3 16 0v6c0 4-4 8-8 8s-8-4-8-8V7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M8 12h.01M16 12h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>';
      $iconGrave = '<svg viewBox="0 0 24 24" fill="none"><path d="M7 21V9a5 5 0 0 1 10 0v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M10 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';

      $realmName = htmlspecialchars((string)($realm['name'] ?? 'Unknown'));
      $realmAddr = htmlspecialchars((string)($realm['address'] ?? ''));
      $realmPort = (int)($realm['port'] ?? 0);
      $snapshotDate = htmlspecialchars((string)($snap['date'] ?? ''));
      $snapshotRows = (int)($snap['rows'] ?? 0);

      $rows = '';
      foreach ($chars as $c) {
        $guid = (int)$c['guid'];
        $name = htmlspecialchars((string)$c['name']);
        $level = (int)$c['level'];
        $isOnline = (int)$c['online'] === 1;
        $state = $isOnline ? '<span class="pill">Online</span>' : '<span class="pill">Offline</span>';
        $disabled = $isOnline ? 'disabled' : '';

        $rows .= <<<HTML
        <tr>
          <td><strong>{$name}</strong><div class="muted">GUID {$guid}</div></td>
          <td>{$level}</td>
          <td>{$state}</td>
          <td>
            <form method="post" style="display:flex;gap:8px;flex-wrap:wrap;">
              <input type="hidden" name="csrf" value="{$csrf}" />
              <input type="hidden" name="guid" value="{$guid}" />
              <button class="btn secondary" type="submit" name="action" value="rename" {$disabled}>{$iconQuill}Rename</button>
              <button class="btn secondary" type="submit" name="action" value="race_change" {$disabled}>{$iconMask}Race Change</button>
              <button class="btn danger" type="submit" name="action" value="unstuck" {$disabled}>{$iconGrave}Unstuck</button>
            </form>
          </td>
        </tr>
        HTML;
      }
      if ($rows === '') {
        $rows = '<tr><td colspan="4" class="muted">No characters found.</td></tr>';
      }

      $mainTitle = 'My Account';
      $mainBody = '';

      if ($tab === 'overview') {
        $mainTitle = 'My Account';
        $mainBody = <<<HTML
          <div class="kpi">
            <div class="card"><div class="muted">Players online</div><div class="val">{$online}</div></div>
          </div>
          <div style="margin-top:12px; display:flex; justify-content:flex-end;">
            <form method="post">
              <input type="hidden" name="csrf" value="{$csrf}" />
              <button class="btn secondary" type="submit" name="action" value="logout">{$iconLogout}Log Out</button>
            </form>
          </div>
        HTML;
      } elseif ($tab === 'characters') {
        $mainTitle = 'Characters';
        $mainBody = <<<HTML
          <table class="table">
            <thead><tr><th>Character</th><th>Level</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>{$rows}</tbody>
          </table>
        HTML;
      } elseif ($tab === 'services') {
        $mainTitle = 'Services';
        $mainBody = <<<HTML
          <div class="muted">Character services are applied on next login (and require the character to be offline).</div>
          <div style="margin-top:12px;">
            <div class="pill">Rename</div>
            <div class="pill">Race Change</div>
            <div class="pill">Unstuck to Graveyard</div>
          </div>
          <div class="muted" style="margin-top:12px;">Go to the Characters tab and use the buttons next to a character.</div>
        HTML;
      } elseif ($tab === 'arena') {
        $charDb = dbName('DB_CHAR_DB', 'acore_characters');

        $teamStmt = $pdo->prepare(
          "SELECT t.name AS team, t.type, t.rating, t.weekGames, t.weekWins, t.seasonGames, t.seasonWins, " .
          "c.name AS captain, c.class AS captainClass, c.level AS captainLevel " .
          "FROM {$charDb}.arena_team t " .
          "LEFT JOIN {$charDb}.characters c ON c.guid = t.captainGuid " .
          "WHERE t.type = :type " .
          "ORDER BY t.rating DESC, t.rank ASC, t.arenaTeamId ASC " .
          "LIMIT 10"
        );

        $brackets = [
          2 => '2v2',
          3 => '3v3',
          5 => '5v5',
        ];

        $sections = '';
        foreach ($brackets as $type => $label) {
          $teamStmt->execute([':type' => $type]);
          $teams = $teamStmt->fetchAll();
          $rows = '';
          foreach ($teams as $t) {
            $team = htmlspecialchars((string)($t['team'] ?? ''));
            $rating = (int)($t['rating'] ?? 0);
            $wg = (int)($t['weekGames'] ?? 0);
            $ww = (int)($t['weekWins'] ?? 0);
            $sg = (int)($t['seasonGames'] ?? 0);
            $sw = (int)($t['seasonWins'] ?? 0);
            $capt = htmlspecialchars((string)($t['captain'] ?? ''));
            $cClass = (int)($t['captainClass'] ?? 0);
            $cLevel = (int)($t['captainLevel'] ?? 0);
            $captCell = $capt !== '' ? (classPill($cClass) . $capt . ' <span class="pill">' . $cLevel . '</span>') : '<span class="muted">—</span>';
            $rows .= '<tr><td><strong>' . $team . '</strong></td><td><span class="pill">' . $rating . '</span></td><td>' . $captCell . '</td><td><span class="pill">' . $ww . '/' . $wg . '</span></td><td><span class="pill">' . $sw . '/' . $sg . '</span></td></tr>';
          }
          if ($rows === '') {
            $rows = '<tr><td colspan="5" class="muted">No teams found for this bracket.</td></tr>';
          }
          $sections .= '<div class="panel" style="margin-top:14px;"><div class="hd"><h2>Arena Ladder ' . htmlspecialchars($label) . '</h2></div><div class="bd"><table class="table"><thead><tr><th>Team</th><th>Rating</th><th>Captain</th><th>Week</th><th>Season</th></tr></thead><tbody>' . $rows . '</tbody></table></div></div>';
        }

        $mainTitle = 'Arena';
        $mainBody = '<div class="muted">Current arena ladder snapshot from the characters database.</div>' . $sections;
      } else {
        $mainTitle = 'Stats';
        $topKills = '';
        foreach ($stats['top_kills'] as $r) {
          $name = htmlspecialchars((string)($r['name'] ?? ''));
          $class = (int)($r['class'] ?? 0);
          $level = (int)($r['level'] ?? 0);
          $gained = (int)($r['gained'] ?? 0);
          $topKills .= '<tr><td>' . classPill($class) . $name . '</td><td><span class="pill">' . $level . '</span></td><td><span class="pill">' . $gained . '</span></td></tr>';
        }
        if ($topKills === '') {
          $topKills = '<tr><td colspan="3" class="muted">Not enough data yet.</td></tr>';
        }
        $topLv = '';
        foreach ($stats['top_levels'] as $r) {
          $name = htmlspecialchars((string)($r['name'] ?? ''));
          $class = (int)($r['class'] ?? 0);
          $level = (int)($r['level'] ?? 0);
          $gained = (int)($r['gained'] ?? 0);
          $topLv .= '<tr><td>' . classPill($class) . $name . '</td><td><span class="pill">' . $level . '</span></td><td><span class="pill">+' . $gained . '</span></td></tr>';
        }
        if ($topLv === '') {
          $topLv = '<tr><td colspan="3" class="muted">Not enough data yet.</td></tr>';
        }
        $mainBody = <<<HTML
          <div class="muted">Last 7 days (based on daily snapshots).</div>
          <div class="row" style="align-items:flex-start;margin-top:10px;">
            <div>
              <div class="muted" style="margin-bottom: 6px;">Top PvP kills</div>
              <table class="table">
                <thead><tr><th>Character</th><th>Lvl</th><th>+Kills</th></tr></thead>
                <tbody>{$topKills}</tbody>
              </table>
            </div>
            <div>
              <div class="muted" style="margin-bottom: 6px;">Top levels gained</div>
              <table class="table">
                <thead><tr><th>Character</th><th>Lvl</th><th>+Levels</th></tr></thead>
                <tbody>{$topLv}</tbody>
              </table>
            </div>
          </div>
        HTML;
      }

      $body = <<<HTML
      <div class="grid">
        <div class="panel">
          <div class="hd"><h2>{$mainTitle}</h2></div>
          <div class="bd">
            {$mainBody}
          </div>
        </div>
        <div>
          <div class="panel">
            <div class="hd"><h2>Realm</h2></div>
            <div class="bd">
              <div><strong>{$realmName}</strong></div>
              <div class="muted" style="margin-top:6px;">Connect: <span class="pill">{$realmAddr}:{$realmPort}</span></div>
              <div class="muted" style="margin-top:10px;">Snapshot: <span class="pill">{$snapshotDate}</span> (<span class="pill">{$snapshotRows}</span>)</div>
            </div>
          </div>
          <div class="panel" style="margin-top:14px;">
            <div class="hd"><h2>Password</h2></div>
            <div class="bd">
              <form method="post">
                <input type="hidden" name="csrf" value="{$csrf}" />
                <input type="hidden" name="action" value="change_password" />
                <label>New password (max 16 chars)</label>
                <input name="new_password" type="password" autocomplete="new-password" required />
                <div style="margin-top:12px;">
                  <button class="btn" type="submit">{$iconKey}Change Password</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      HTML;

      render($body, $flash, $flashKind);
    }

    ensureSession();
    requireCloudflareAccessIfEnabled();

    $flash = '';
    $flashKind = 'info';

    try {
      $pdo = db();
      $stats = getStats($pdo);
      $realm = getRealmInfo($pdo);
      $snap = getSnapshotInfo($pdo);

      if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $action = (string)($_POST['action'] ?? '');
        requireCsrf();

        if ($action === 'logout') {
          logout();
          header('Location: /');
          exit;
        }

        if ($action === 'login') {
          $loginUser = (string)($_POST['login_user'] ?? '');
          $loginPass = (string)($_POST['login_pass'] ?? '');
          $res = tryLogin($loginUser, $loginPass);
          session_regenerate_id(true);
          $_SESSION['account_id'] = $res['account_id'];
          $_SESSION['username'] = $res['username'];
          header('Location: /');
          exit;
        }

        if ($action === 'signup') {
          if (!isSignupEnabled()) {
            throw new RuntimeException("Sign up is disabled.");
          }
          $username = normalizeUsername((string)($_POST['username'] ?? ''));
          $password = validatePassword((string)($_POST['password'] ?? ''));
          $email = validateEmail((string)($_POST['email'] ?? ''));
          requireInviteCode((string)($_POST['invite'] ?? ''));
          soapExecute('account create ' . $username . ' ' . $password . ' ' . $email);
          $flash = "Created account: {$username}";
          $flashKind = 'ok';
        } elseif ($action === 'change_password') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          $newPass = validatePassword((string)($_POST['new_password'] ?? ''));
          $u = currentUsername();
          soapExecute('account set password ' . $u . ' ' . $newPass . ' ' . $newPass);
          $flash = "Password updated.";
          $flashKind = 'ok';
        } elseif ($action === 'rename' || $action === 'race_change' || $action === 'unstuck') {
          if (!isLoggedIn()) {
            throw new RuntimeException("Login required.");
          }
          $guid = (int)($_POST['guid'] ?? 0);
          if ($guid <= 0) {
            throw new RuntimeException("Invalid character.");
          }

          $char = characterBelongsTo($pdo, currentAccountId(), $guid);
          if ((int)$char['online'] === 1) {
            throw new RuntimeException("Character must be offline.");
          }

          if ($action === 'rename') {
            setAtLoginFlag($pdo, $guid, 0x01);
            $flash = "Rename queued for {$char['name']}.";
            $flashKind = 'ok';
          } elseif ($action === 'race_change') {
            setAtLoginFlag($pdo, $guid, 0x80);
            $flash = "Race change queued for {$char['name']}.";
            $flashKind = 'ok';
          } else {
            unstuckToGraveyard($pdo, $char);
            $flash = "Moved {$char['name']} to the nearest graveyard.";
            $flashKind = 'ok';
          }
        } elseif ($action !== '') {
          throw new RuntimeException("Unknown action.");
        }
      }

      if (!isLoggedIn()) {
        renderLoginPage($stats, $realm, $snap, $flash, $flashKind);
      }

      $chars = listCharacters($pdo, currentAccountId());
      renderPortal($pdo, $stats, $realm, $snap, $chars, $flash, $flashKind);
    } catch (Throwable $e) {
      // If DB is down or extensions missing, render a simple page.
      $msg = $e->getMessage();
      render('<div class="panel"><div class="hd"><h2>Portal Error</h2></div><div class="bd"><div class="flash err">' . htmlspecialchars($msg) . '</div><div class="muted">If this is new, wait a minute after a rollout and refresh.</div></div></div>', 'Portal error', 'err');
    }
