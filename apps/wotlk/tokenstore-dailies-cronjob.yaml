apiVersion: batch/v1
kind: CronJob
metadata:
  name: wotlk-tokenstore-dailies
  namespace: wotlk
spec:
  # Runs daily to ensure token item + quest wiring exists.
  schedule: "0 0 * * *"
  timeZone: Australia/Adelaide
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: tokenstore-dailies
              image: mysql:8.0
              env:
                - name: DB_HOST
                  value: wotlk-mariadb.wotlk.svc.cluster.local
                - name: DB_PORT
                  value: "3306"
                - name: DB_ROOT_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: wotlk-mariadb-auth
                      key: MARIADB_ROOT_PASSWORD
              command:
                - sh
                - -lc
                - |
                  set -euo pipefail

                  db() {
                    command mysql \
                      --protocol=tcp \
                      --host "${DB_HOST}" \
                      --port "${DB_PORT}" \
                      --user root \
                      --password="${DB_ROOT_PASSWORD}" \
                      --ssl-mode=DISABLED \
                      --get-server-public-key \
                      "$@"
                  }

                  TOKEN_ITEM_ID="${TOKEN_ITEM_ID:-90000}"
                  CLASSIC_DUTY_ITEM_ID="${CLASSIC_DUTY_ITEM_ID:-90001}"
                  TBC_DUTY_ITEM_ID="${TBC_DUTY_ITEM_ID:-90002}"

                  QUEST_CLASSIC_ID="${QUEST_CLASSIC_ID:-210010}"
                  QUEST_TBC_ID="${QUEST_TBC_ID:-210011}"

                  DUTY_NPC_ALLIANCE="${DUTY_NPC_ALLIANCE:-900100}"
                  DUTY_NPC_HORDE="${DUTY_NPC_HORDE:-900101}"
                  SW_X="${SW_X:--8787.976}"
                  SW_Y="${SW_Y:-640.2761}"
                  SW_Z="${SW_Z:-69.12814}"
                  SW_O="${SW_O:-3.0963876}"
                  SW_ZONE="${SW_ZONE:-11519}"
                  SW_AREA="${SW_AREA:-1519}"
                  SW_PHASEMASK="${SW_PHASEMASK:-1}"
                  SW_GUARD_TEMPLATE="${SW_GUARD_TEMPLATE:-1423}" # Stormwind Guard
                  ORG_X="${ORG_X:-1651.4655}"
                  ORG_Y="${ORG_Y:--4434.145}"
                  ORG_Z="${ORG_Z:-17.602255}"
                  ORG_O="${ORG_O:-1.7898299}"
                  ORG_ZONE="${ORG_ZONE:-1637}"
                  ORG_AREA="${ORG_AREA:-1637}"
                  ORG_PHASEMASK="${ORG_PHASEMASK:-4294967295}"
                  ORG_GRUNT_TEMPLATE="${ORG_GRUNT_TEMPLATE:-3296}" # Orgrimmar Grunt

                  # Existing auctioneers used previously as quest givers (we remove any quest links from them).
                  AUCTIONEER_ALLIANCE="${AUCTIONEER_ALLIANCE:-15659}" # Auctioneer Jaxon (Stormwind)
                  AUCTIONEER_HORDE="${AUCTIONEER_HORDE:-8724}"       # Auctioneer Wabang (Orgrimmar)

                  # Exclude known raid end-bosses (these values match instance_encounters.lastEncounterDungeon in your DB).
                  EXCLUDE_CLASSIC_RAID_DUNGEON_IDS="42,48,50,160,161"
                  EXCLUDE_TBC_RAID_DUNGEON_IDS="175,176,177,193,194,195,196,197,198,199,201"

                  # WotLK heroic "Proof of Demise" quest IDs (end-boss daily series).
                  # These already exist in the DB; we just ensure they reward tokens.
                  HEROIC_PROOF_QUESTS="13245,13246,13247,13248,13249,13250,13251,13252,13253,13254,13255,13256,14199"

                  echo "Ensuring token + duty items exist..."
                  db --database acore_world --execute "
                    INSERT IGNORE INTO item_template
                      (entry, class, subclass, name, displayid, Quality, bonding, stackable, maxcount, BuyPrice, SellPrice, description)
                    VALUES
                      (${TOKEN_ITEM_ID}, 10, 0, 'Grim Token', 64062, 2, 1, 1000, 0, 0, 1, 'Earned from daily dungeon quests. Used for vanity rewards in the portal store.'),
                      (${CLASSIC_DUTY_ITEM_ID}, 12, 0, 'Dungeon Duty Mark', 134944, 1, 1, 1, 1, 0, 0, 'Taken from the final boss of any classic dungeon.'),
                      (${TBC_DUTY_ITEM_ID}, 12, 0, 'Faction Service Mark', 134944, 1, 1, 1, 1, 0, 0, 'Taken from the final boss of any Outland dungeon.');

                    UPDATE item_template
                      SET bonding = 1, SellPrice = 1, BuyPrice = 0, stackable = 1000
                      WHERE entry = ${TOKEN_ITEM_ID};
                  "

                  echo "Ensuring heroic proof quests reward 5 tokens..."
                  db --database acore_world --execute "
                    UPDATE quest_template
                      SET RewardItem1 = ${TOKEN_ITEM_ID}, RewardAmount1 = 5
                      WHERE ID IN (${HEROIC_PROOF_QUESTS});
                  "

                  echo "Ensuring dedicated questgiver NPCs exist (SW/Org)..."
                  db --database acore_world --execute "
                    INSERT INTO creature_template
                      (entry, difficulty_entry_1, difficulty_entry_2, difficulty_entry_3, KillCredit1, KillCredit2, name, subname, IconName,
                       gossip_menu_id, minlevel, maxlevel, exp, faction, npcflag, speed_walk, speed_run, speed_swim, speed_flight,
                       detection_range, scale, \`rank\`, dmgschool, DamageModifier, BaseAttackTime, RangeAttackTime, BaseVariance, RangeVariance,
                       unit_class, unit_flags, unit_flags2, dynamicflags, family,
                       \`type\`, type_flags, lootid, pickpocketloot, skinloot, PetSpellDataId, VehicleId, mingold, maxgold, AIName, MovementType,
                       HoverHeight, HealthModifier, ManaModifier, ArmorModifier, ExperienceModifier, RacialLeader, movementId, RegenHealth,
                       mechanic_immune_mask, spell_school_immune_mask, flags_extra, ScriptName, VerifiedBuild)
                    SELECT
                      ${DUTY_NPC_ALLIANCE},
                      difficulty_entry_1, difficulty_entry_2, difficulty_entry_3, KillCredit1, KillCredit2,
                      'Grim Token Envoy', 'Daily Dungeon Rewards', IconName,
                      gossip_menu_id, minlevel, maxlevel, exp, faction,
                      2,
                      speed_walk, speed_run, speed_swim, speed_flight,
                      detection_range, scale, \`rank\`, dmgschool, DamageModifier, BaseAttackTime, RangeAttackTime, BaseVariance, RangeVariance,
                      unit_class, unit_flags, unit_flags2, dynamicflags, family,
                      \`type\`, type_flags, lootid, pickpocketloot, skinloot, PetSpellDataId, VehicleId, mingold, maxgold, AIName, MovementType,
                      HoverHeight, HealthModifier, ManaModifier, ArmorModifier, ExperienceModifier, RacialLeader, movementId, RegenHealth,
                      mechanic_immune_mask, spell_school_immune_mask, flags_extra, ScriptName, VerifiedBuild
                    FROM creature_template
                    WHERE entry = ${AUCTIONEER_ALLIANCE}
                      AND NOT EXISTS (SELECT 1 FROM creature_template WHERE entry = ${DUTY_NPC_ALLIANCE});

                    INSERT INTO creature_template
                      (entry, difficulty_entry_1, difficulty_entry_2, difficulty_entry_3, KillCredit1, KillCredit2, name, subname, IconName,
                       gossip_menu_id, minlevel, maxlevel, exp, faction, npcflag, speed_walk, speed_run, speed_swim, speed_flight,
                       detection_range, scale, \`rank\`, dmgschool, DamageModifier, BaseAttackTime, RangeAttackTime, BaseVariance, RangeVariance,
                       unit_class, unit_flags, unit_flags2, dynamicflags, family,
                       \`type\`, type_flags, lootid, pickpocketloot, skinloot, PetSpellDataId, VehicleId, mingold, maxgold, AIName, MovementType,
                       HoverHeight, HealthModifier, ManaModifier, ArmorModifier, ExperienceModifier, RacialLeader, movementId, RegenHealth,
                       mechanic_immune_mask, spell_school_immune_mask, flags_extra, ScriptName, VerifiedBuild)
                    SELECT
                      ${DUTY_NPC_HORDE},
                      difficulty_entry_1, difficulty_entry_2, difficulty_entry_3, KillCredit1, KillCredit2,
                      'Grim Token Envoy', 'Daily Dungeon Rewards', IconName,
                      gossip_menu_id, minlevel, maxlevel, exp, faction,
                      2,
                      speed_walk, speed_run, speed_swim, speed_flight,
                      detection_range, scale, \`rank\`, dmgschool, DamageModifier, BaseAttackTime, RangeAttackTime, BaseVariance, RangeVariance,
                      unit_class, unit_flags, unit_flags2, dynamicflags, family,
                      \`type\`, type_flags, lootid, pickpocketloot, skinloot, PetSpellDataId, VehicleId, mingold, maxgold, AIName, MovementType,
                      HoverHeight, HealthModifier, ManaModifier, ArmorModifier, ExperienceModifier, RacialLeader, movementId, RegenHealth,
                      mechanic_immune_mask, spell_school_immune_mask, flags_extra, ScriptName, VerifiedBuild
                    FROM creature_template
                    WHERE entry = ${AUCTIONEER_HORDE}
                      AND NOT EXISTS (SELECT 1 FROM creature_template WHERE entry = ${DUTY_NPC_HORDE});
                  "

                  echo "Applying Stormwind Guard model to SW envoy..."
                  db --database acore_world --execute "
                    DELETE FROM creature_template_model WHERE CreatureID = ${DUTY_NPC_ALLIANCE};
                    INSERT INTO creature_template_model (CreatureID, Idx, CreatureDisplayID, DisplayScale, Probability, VerifiedBuild)
                    SELECT ${DUTY_NPC_ALLIANCE}, Idx, CreatureDisplayID, DisplayScale, Probability, VerifiedBuild
                    FROM creature_template_model
                    WHERE CreatureID = ${SW_GUARD_TEMPLATE};
                  "

                  echo "Applying Orgrimmar Grunt model to Org envoy..."
                  db --database acore_world --execute "
                    DELETE FROM creature_template_model WHERE CreatureID = ${DUTY_NPC_HORDE};
                    INSERT INTO creature_template_model (CreatureID, Idx, CreatureDisplayID, DisplayScale, Probability, VerifiedBuild)
                    SELECT ${DUTY_NPC_HORDE}, Idx, CreatureDisplayID, DisplayScale, Probability, VerifiedBuild
                    FROM creature_template_model
                    WHERE CreatureID = ${ORG_GRUNT_TEMPLATE};
                  "

                  db --database acore_world --execute "
                    INSERT INTO creature
                      (id1, id2, id3, map, zoneId, areaId, spawnMask, phaseMask, equipment_id,
                       position_x, position_y, position_z, orientation,
                       spawntimesecs, wander_distance, currentwaypoint,
                       curhealth, curmana, MovementType, npcflag, unit_flags, dynamicflags, ScriptName, VerifiedBuild, CreateObject, Comment)
                    SELECT
                      ${DUTY_NPC_ALLIANCE}, id2, id3, 0, ${SW_ZONE}, ${SW_AREA}, spawnMask, ${SW_PHASEMASK}, equipment_id,
                      ${SW_X}, ${SW_Y}, ${SW_Z}, ${SW_O},
                      spawntimesecs, 0, currentwaypoint,
                      curhealth, curmana, MovementType, 0, unit_flags, dynamicflags, ScriptName, VerifiedBuild, CreateObject, 'Grim token questgiver (SW)'
                    FROM creature
                    WHERE id1 = ${AUCTIONEER_ALLIANCE}
                      AND NOT EXISTS (SELECT 1 FROM creature WHERE id1 = ${DUTY_NPC_ALLIANCE})
                    ORDER BY guid
                    LIMIT 1;

                    UPDATE creature
                      SET map = 0,
                          zoneId = ${SW_ZONE},
                          areaId = ${SW_AREA},
                          phaseMask = ${SW_PHASEMASK},
                          position_x = ${SW_X},
                          position_y = ${SW_Y},
                          position_z = ${SW_Z},
                          orientation = ${SW_O},
                          wander_distance = 0
                      WHERE id1 = ${DUTY_NPC_ALLIANCE};

                    INSERT INTO creature
                      (id1, id2, id3, map, zoneId, areaId, spawnMask, phaseMask, equipment_id,
                       position_x, position_y, position_z, orientation,
                       spawntimesecs, wander_distance, currentwaypoint,
                       curhealth, curmana, MovementType, npcflag, unit_flags, dynamicflags, ScriptName, VerifiedBuild, CreateObject, Comment)
                    SELECT
                      ${DUTY_NPC_HORDE}, id2, id3, 1, ${ORG_ZONE}, ${ORG_AREA}, spawnMask, ${ORG_PHASEMASK}, equipment_id,
                      ${ORG_X}, ${ORG_Y}, ${ORG_Z}, ${ORG_O},
                      spawntimesecs, 0, currentwaypoint,
                      curhealth, curmana, MovementType, 0, unit_flags, dynamicflags, ScriptName, VerifiedBuild, CreateObject, 'Grim token questgiver (Org)'
                    FROM creature
                    WHERE id1 = ${AUCTIONEER_HORDE}
                      AND NOT EXISTS (SELECT 1 FROM creature WHERE id1 = ${DUTY_NPC_HORDE})
                    ORDER BY guid
                    LIMIT 1;

                    UPDATE creature
                      SET map = 1,
                          zoneId = ${ORG_ZONE},
                          areaId = ${ORG_AREA},
                          phaseMask = ${ORG_PHASEMASK},
                          position_x = ${ORG_X},
                          position_y = ${ORG_Y},
                          position_z = ${ORG_Z},
                          orientation = ${ORG_O},
                          wander_distance = 0
                      WHERE id1 = ${DUTY_NPC_HORDE};
                  "

                  echo "Upserting bracket dailies (classic + Outland)..."
                  db --database acore_world --execute "
                    INSERT INTO quest_template
                      (ID, QuestType, QuestLevel, MinLevel, QuestSortID, QuestInfoID, SuggestedGroupNum, Flags,
                       RewardXPDifficulty, RewardMoney,
                       RewardItem1, RewardAmount1,
                       RequiredItemId1, RequiredItemCount1,
                       LogTitle, LogDescription, QuestDescription, QuestCompletionLog,
                       ObjectiveText1)
                    VALUES
                      (
                      ${QUEST_CLASSIC_ID},
                      2,
                      -1,
                      15,
                      206,
                      85,
                      5,
                      4232,
                      8,
                      0,
                      ${TOKEN_ITEM_ID},
                      1,
                      ${CLASSIC_DUTY_ITEM_ID},
                      1,
                      'Doing Your Duty',
                      'The Grim Token Envoy has a daily task for you: clear a classic dungeon and bring back proof of victory.',
                      'The Envoy keeps the realm safe by marking the deeds of its champions. Join a Dungeon Finder run for a classic dungeon, defeat the final boss, and recover a Dungeon Duty Mark as proof. Return to claim your reward.',
                      'Well done. The Envoy marks your service to the realm.',
                      'Recover a Dungeon Duty Mark from a classic dungeon''s final boss.'
                      ),
                      (
                      ${QUEST_TBC_ID},
                      2,
                      -1,
                      61,
                      206,
                      85,
                      5,
                      4232,
                      8,
                      0,
                      ${TOKEN_ITEM_ID},
                      2,
                      ${TBC_DUTY_ITEM_ID},
                      1,
                      'Service to Your Faction',
                      'The Envoy calls for Outland veterans to prove their service and earn their tokens.',
                      'The armies of Outland still need stalwart allies. Enter any Outland dungeon via the Dungeon Finder, defeat the final boss, and recover a Faction Service Mark as proof. Return to claim your reward.',
                      'Your service brings honor to your faction.',
                      'Recover a Faction Service Mark from an Outland dungeon''s final boss.'
                      )
                    ON DUPLICATE KEY UPDATE
                      QuestLevel = VALUES(QuestLevel),
                      MinLevel = VALUES(MinLevel),
                      QuestSortID = VALUES(QuestSortID),
                      QuestInfoID = VALUES(QuestInfoID),
                      RewardXPDifficulty = VALUES(RewardXPDifficulty),
                      RewardMoney = VALUES(RewardMoney),
                      RewardItem1 = VALUES(RewardItem1),
                      RewardAmount1 = VALUES(RewardAmount1),
                      RequiredItemId1 = VALUES(RequiredItemId1),
                      RequiredItemCount1 = VALUES(RequiredItemCount1),
                      Flags = VALUES(Flags),
                      LogTitle = VALUES(LogTitle),
                      LogDescription = VALUES(LogDescription),
                      QuestDescription = VALUES(QuestDescription),
                      QuestCompletionLog = VALUES(QuestCompletionLog),
                      ObjectiveText1 = VALUES(ObjectiveText1);
                  "

                  echo "Linking bracket dailies to quest givers..."
                  db --database acore_world --execute "
                    DELETE FROM creature_queststarter
                      WHERE quest IN (${QUEST_CLASSIC_ID}, ${QUEST_TBC_ID})
                        AND id IN (${AUCTIONEER_ALLIANCE}, ${AUCTIONEER_HORDE});
                    DELETE FROM creature_questender
                      WHERE quest IN (${QUEST_CLASSIC_ID}, ${QUEST_TBC_ID})
                        AND id IN (${AUCTIONEER_ALLIANCE}, ${AUCTIONEER_HORDE});

                    INSERT IGNORE INTO creature_queststarter (id, quest) VALUES
                      (${DUTY_NPC_ALLIANCE}, ${QUEST_CLASSIC_ID}),
                      (${DUTY_NPC_HORDE}, ${QUEST_CLASSIC_ID}),
                      (${DUTY_NPC_ALLIANCE}, ${QUEST_TBC_ID}),
                      (${DUTY_NPC_HORDE}, ${QUEST_TBC_ID});

                    INSERT IGNORE INTO creature_questender (id, quest) VALUES
                      (${DUTY_NPC_ALLIANCE}, ${QUEST_CLASSIC_ID}),
                      (${DUTY_NPC_HORDE}, ${QUEST_CLASSIC_ID}),
                      (${DUTY_NPC_ALLIANCE}, ${QUEST_TBC_ID}),
                      (${DUTY_NPC_HORDE}, ${QUEST_TBC_ID});
                  "

                  echo "Ensuring final bosses drop duty marks (quest-required loot)..."
                  db --database acore_world --execute "
                    INSERT INTO creature_loot_template
                      (Entry, Item, Reference, Chance, QuestRequired, LootMode, GroupId, MinCount, MaxCount, Comment)
                    SELECT
                      DISTINCT ie.creditEntry AS boss_entry,
                      ${CLASSIC_DUTY_ITEM_ID},
                      0,
                      100,
                      1,
                      1,
                      0,
                      1,
                      1,
                      'Grim classic duty mark'
                    FROM instance_encounters ie
                    JOIN creature_template ct ON ct.entry = ie.creditEntry
                    WHERE ie.lastEncounterDungeon != 0
                      AND ie.creditType = 0
                      AND ct.exp = 0
                      AND ie.lastEncounterDungeon NOT IN (${EXCLUDE_CLASSIC_RAID_DUNGEON_IDS})
                    ON DUPLICATE KEY UPDATE
                      Chance = VALUES(Chance),
                      QuestRequired = VALUES(QuestRequired),
                      LootMode = VALUES(LootMode),
                      GroupId = VALUES(GroupId),
                      MinCount = VALUES(MinCount),
                      MaxCount = VALUES(MaxCount),
                      Comment = VALUES(Comment);
                  "

                  db --database acore_world --execute "
                    INSERT INTO creature_loot_template
                      (Entry, Item, Reference, Chance, QuestRequired, LootMode, GroupId, MinCount, MaxCount, Comment)
                    SELECT
                      DISTINCT ie.creditEntry AS boss_entry,
                      ${TBC_DUTY_ITEM_ID},
                      0,
                      100,
                      1,
                      1,
                      0,
                      1,
                      1,
                      'Grim TBC duty mark'
                    FROM instance_encounters ie
                    JOIN creature_template ct ON ct.entry = ie.creditEntry
                    WHERE ie.lastEncounterDungeon != 0
                      AND ie.creditType = 0
                      AND ct.exp = 1
                      AND ie.lastEncounterDungeon NOT IN (${EXCLUDE_TBC_RAID_DUNGEON_IDS})
                    ON DUPLICATE KEY UPDATE
                      Chance = VALUES(Chance),
                      QuestRequired = VALUES(QuestRequired),
                      LootMode = VALUES(LootMode),
                      GroupId = VALUES(GroupId),
                      MinCount = VALUES(MinCount),
                      MaxCount = VALUES(MaxCount),
                      Comment = VALUES(Comment);
                  "

                  echo "Done. Counts:"
                  db --database acore_world --execute "
                    SELECT 'token_item' AS k, COUNT(*) AS v FROM item_template WHERE entry = ${TOKEN_ITEM_ID}
                    UNION ALL SELECT 'classic_daily' AS k, COUNT(*) AS v FROM quest_template WHERE ID = ${QUEST_CLASSIC_ID}
                    UNION ALL SELECT 'tbc_daily' AS k, COUNT(*) AS v FROM quest_template WHERE ID = ${QUEST_TBC_ID};
                  "
