apiVersion: batch/v1
kind: CronJob
metadata:
  name: wow-client-extract
  namespace: wow
spec:
  # Suspended by default; run manually:
  # kubectl -n wow create job --from=cronjob/wow-client-extract wow-client-extract-1
  suspend: true
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          volumes:
            - name: client
              persistentVolumeClaim:
                claimName: wow-client-files
            - name: data
              persistentVolumeClaim:
                claimName: wow-data-rwx
            - name: work
              emptyDir: {}
          containers:
            - name: extract
              image: ghcr.io/rovxbot/mangoszero:server-v22.04.105
              imagePullPolicy: Always
              env:
                - name: WOW_SKIP_MMAPS
                  value: "true"
              command:
                - sh
                - -lc
                - |
                  set -eu

                  if [ -d /data/maps ] && [ -d /data/vmaps ] && [ -d /data/dbc ]; then
                    echo "Client data already present in /data (maps/vmaps/dbc). Nothing to do."
                    exit 0
                  fi

                  if [ ! -d /client/Data ]; then
                    echo "Expected /client/Data to exist (WoW 1.12.1 client files). Check the NFS path." >&2
                    exit 1
                  fi

                  echo "Preparing workspace..."
                  mkdir -p /work
                  rm -rf /work/out
                  mkdir -p /work/out
                  cd /work/out

                  echo "Running map extractor..."
                  /opt/mangos/bin/tools/map-extractor -i /client -o /work/out -f 0 -e 3

                  echo "Running vmap extractor..."
                  /opt/mangos/bin/tools/vmap-extractor -i /client -s

                  if [ "${WOW_SKIP_MMAPS}" = "true" ]; then
                    echo "Skipping mmaps extraction (WOW_SKIP_MMAPS=true)"
                  else
                    echo "Running mmap extractor (can take hours)..."
                    /opt/mangos/bin/tools/mmap-extractor -i /client
                  fi

                  echo "Copying extracted data to /data..."
                  mkdir -p /data
                  [ -d maps ] && cp -a maps /data/
                  [ -d dbc ] && cp -a dbc /data/
                  [ -d Buildings ] && cp -a Buildings /data/ || true
                  [ -d vmaps ] && cp -a vmaps /data/
                  [ -d mmaps ] && cp -a mmaps /data/ || true

                  echo "Done."
              volumeMounts:
                - name: client
                  mountPath: /client
                  readOnly: true
                - name: data
                  mountPath: /data
                - name: work
                  mountPath: /work
