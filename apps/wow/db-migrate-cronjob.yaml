apiVersion: batch/v1
kind: CronJob
metadata:
  name: wow-db-sync
  namespace: wow
spec:
  # Suspended by default; run manually when ready:
  # kubectl -n wow create job --from=cronjob/wow-db-sync wow-db-sync-1
  suspend: true
  schedule: "0 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        spec:
          restartPolicy: Never
          volumes:
            - name: work
              emptyDir: {}
          initContainers:
            - name: clone
              image: alpine/git:2.47.2
              env:
                - name: WOW_DB_REPO
                  value: https://github.com/RovxBot/1.12.1-database.git
                - name: WOW_DB_REF
                  value: master
              command:
                - sh
                - -lc
                - |
                  set -eu
                  rm -rf /work/repo
                  git clone --depth=1 --branch "${WOW_DB_REF}" "${WOW_DB_REPO}" /work/repo
              volumeMounts:
                - name: work
                  mountPath: /work
          containers:
            - name: mariadb-client
              image: mariadb:11.4
              env:
                - name: DB_HOST
                  value: wow-mariadb.wow.svc.cluster.local
                - name: DB_PORT
                  value: "3306"
                - name: DB_ROOT_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: wow-mariadb-auth
                      key: MARIADB_ROOT_PASSWORD
                # Repo layout defaults (adjust to match your content repo):
                - name: WOW_DB_BOOTSTRAP_DIR
                  value: /work/repo/bootstrap
                - name: WOW_DB_MIGRATIONS_DIR
                  value: /work/repo/migrations
                # Vanilla DB names (match upstream defaults).
                - name: WOW_REALM_DB
                  value: realmd
                - name: WOW_WORLD_DB
                  value: mangos0
                - name: WOW_CHAR_DB
                  value: character0
                # Realm entry (for LAN NodePort access via metal7)
                - name: WOW_REALM_ID
                  value: "1"
                - name: WOW_REALM_NAME
                  value: "cooked.beer (vanilla)"
                - name: WOW_REALM_ADDRESS
                  value: "192.168.1.197"
                - name: WOW_REALM_PORT
                  value: "30085"
                - name: WOW_DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: wow-mariadb-auth
                      key: MARIADB_USER
                - name: WOW_DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: wow-mariadb-auth
                      key: MARIADB_PASSWORD
              command:
                - sh
                - -lc
                - |
                  set -eu

                  db() {
                    command mariadb \
                      --protocol=tcp \
                      --host "${DB_HOST}" \
                      --port "${DB_PORT}" \
                      --user root \
                      --password="${DB_ROOT_PASSWORD}" \
                      "$@"
                  }

                  echo "Waiting for MariaDB at ${DB_HOST}:${DB_PORT}..."
                  for _ in $(seq 1 120); do
                    if db --execute "SELECT 1" >/dev/null 2>&1; then
                      break
                    fi
                    sleep 2
                  done

                  ensure_db() {
                    dbname="$1"
                    db --execute "CREATE DATABASE IF NOT EXISTS \`${dbname}\`;"
                  }

                  ensure_user_grants() {
                    # Ensure the app user can access all DBs (idempotent).
                    db --execute "CREATE USER IF NOT EXISTS '${WOW_DB_USER}'@'%' IDENTIFIED BY '${WOW_DB_PASSWORD}';"
                    db --execute "GRANT ALL PRIVILEGES ON \`${WOW_REALM_DB}\`.* TO '${WOW_DB_USER}'@'%';"
                    db --execute "GRANT ALL PRIVILEGES ON \`${WOW_WORLD_DB}\`.* TO '${WOW_DB_USER}'@'%';"
                    db --execute "GRANT ALL PRIVILEGES ON \`${WOW_CHAR_DB}\`.* TO '${WOW_DB_USER}'@'%';"
                    db --execute "FLUSH PRIVILEGES;"
                  }

                  bootstrap_if_empty() {
                    dbname="$1"
                    dir="$2"
                    table_count="$(db --database "${dbname}" --skip-column-names --batch --execute "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='${dbname}';")"
                    if [ "${table_count}" -eq 0 ]; then
                      if [ -d "${dir}" ]; then
                        echo "Bootstrapping ${dbname} from ${dir}..."
                        find "${dir}" -maxdepth 1 -type f -name '*.sql' -print | sort | while read -r f; do
                          echo "Applying bootstrap (${dbname}): ${f##*/}"
                          db --database "${dbname}" < "$f"
                        done
                      else
                        echo "DB ${dbname} is empty, but no bootstrap dir found at ${dir}; skipping."
                      fi
                    else
                      echo "DB ${dbname} already initialized (${table_count} tables); skipping bootstrap."
                    fi
                  }

                  ensure_db "${WOW_REALM_DB}"
                  ensure_db "${WOW_WORLD_DB}"
                  ensure_db "${WOW_CHAR_DB}"
                  ensure_user_grants

                  bootstrap_if_empty "${WOW_REALM_DB}" "${WOW_DB_BOOTSTRAP_DIR}/${WOW_REALM_DB}"
                  bootstrap_if_empty "${WOW_WORLD_DB}" "${WOW_DB_BOOTSTRAP_DIR}/${WOW_WORLD_DB}"
                  bootstrap_if_empty "${WOW_CHAR_DB}" "${WOW_DB_BOOTSTRAP_DIR}/${WOW_CHAR_DB}"

                  # Ensure realm record points to the LAN node/port (idempotent; assumes sane defaults in schema).
                  db --database "${WOW_REALM_DB}" --execute "INSERT INTO realmlist (id, name, address, port) VALUES (${WOW_REALM_ID}, '${WOW_REALM_NAME}', '${WOW_REALM_ADDRESS}', ${WOW_REALM_PORT}) ON DUPLICATE KEY UPDATE name=VALUES(name), address=VALUES(address), port=VALUES(port);"

                  # Apply custom migrations to world DB (gates/tweaks live here).
                  if [ -d "${WOW_DB_MIGRATIONS_DIR}" ]; then
                    echo "Applying world migrations from ${WOW_DB_MIGRATIONS_DIR}..."
                    find "${WOW_DB_MIGRATIONS_DIR}" -maxdepth 1 -type f -name '*.sql' -print | sort | while read -r f; do
                      echo "Applying migration: ${f##*/}"
                      db --database "${WOW_WORLD_DB}" < "$f"
                    done
                  else
                    echo "No migrations dir found at ${WOW_DB_MIGRATIONS_DIR}; nothing to do."
                  fi
              volumeMounts:
                - name: work
                  mountPath: /work
